// pnltri.js / raw.github.com/jahting/pnltri.js/master/LICENSE
'use strict';var PNLTRI={REVISION:"0.8"};PNLTRI.Math={log2:function(a){return Math.log(a)/Math.LN2},random:Math.random,array_shuffle:function(a){for(var b=a.length-1;0<b;b--){var c=Math.floor(PNLTRI.Math.random()*(b+1)),d=a[b];a[b]=a[c];a[c]=d}return a},ptsCrossProd:function(a,b,c){return(b.x-a.x)*(c.y-a.y)-(b.y-a.y)*(c.x-a.x)}};PNLTRI.Math.EPSILON_P=Math.pow(2,-43);PNLTRI.Math.EPSILON_N=-PNLTRI.Math.EPSILON_P;PNLTRI.PolygonData=function(a){this.vertices=[];this.segments=[];this.monoSubPolyChains=[];this.triangles=[];if(a){this.addPolygonChain(a[0],!1);for(var b=1,c=a.length;b<c;b++)this.addPolygonChain(a[b],!0)}};
PNLTRI.PolygonData.prototype={constructor:PNLTRI.PolygonData,getSegments:function(){return this.segments},getMonoSubPolys:function(){return this.monoSubPolyChains},getTriangles:function(){return this.triangles.concat()},compare_pts_yx:function(a,b){var c=a.y-b.y;if(c>PNLTRI.Math.EPSILON_P)return 1;if(c<PNLTRI.Math.EPSILON_N)return-1;c=a.x-b.x;return c>PNLTRI.Math.EPSILON_P?1:c<PNLTRI.Math.EPSILON_N?-1:0},polygon_area:function(a){for(var b=a.length,c=0,d=b-1,e=0;e<b;d=e++)c+=a[d].x*a[e].y-a[e].x*a[d].y;
return 0.5*c},appendVertexEntry:function(a){a=a?a:{x:null,y:null,outSegs:[]};a.id=this.vertices.length;this.vertices.push(a);return a},createSegmentEntry:function(a,b){return{vFrom:a,vTo:b,upward:1==this.compare_pts_yx(b,a),sprev:null,snext:null}},appendSegmentEntry:function(a){this.segments.push(a);0==this.monoSubPolyChains.length&&(this.monoSubPolyChains=[this.segments[0]]);return a},addVertexChain:function(a,b){function c(a,b){return Math.abs(a.x-b.x)<PNLTRI.Math.EPSILON_P&&Math.abs(a.y-b.y)<PNLTRI.Math.EPSILON_P}
var d=!1;null!=b&&(d=0>this.polygon_area(a),d=b!=d);for(var e=[],k,n,g,h=0;h<a.length;h++)k=this.appendVertexEntry({x:a[h].x,y:a[h].y}),n=!0,g=e.length-1,0<=g&&c(k,e[g])&&(n=!1),n&&e.push(k);1<e.length&&c(e[e.length-1],e[0])&&e.pop();d&&(e=e.reverse());return e},addPolygonChain:function(a,b){var c=this.addVertexChain(a,b);if(3>c.length)return console.log("Polygon has < 3 vertices!",c),0;for(var d=this.segments.length,e,k,n,g=0;g<c.length-1;g++)e=this.createSegmentEntry(c[g],c[g+1]),n?(e.sprev=n,n.snext=
e):k=e,n=e,this.appendSegmentEntry(e);e=this.createSegmentEntry(c[c.length-1],c[0]);e.sprev=n;n.snext=e;this.appendSegmentEntry(e);k.sprev=e;e.snext=k;return this.segments.length-d},initMonoChains:function(){for(var a=0;a<this.segments.length;a++)this.segments[a].marked=!1,this.segments[a].mprev=this.segments[a].sprev,this.segments[a].mnext=this.segments[a].snext,this.segments[a].vFrom.outSegs=[{segOut:this.segments[a],vertTo:this.segments[a].vTo}]},appendVertexOutsegEntry:function(a,b){var c=b?b:
{segOut:null,vertTo:null};a.outSegs.push(c);return c},splitPolygonChain:function(a,b,c){function d(a,b){for(var c,d,e=null,g=4,m=0;m<a.outSegs.length;m++){c=a.outSegs[m];var k=c.vertTo;d=k.x-a.x;var k=k.y-a.y,n=b.x-a.x,u=b.y-a.y,v=(d*n+k*u)/Math.sqrt(d*d+k*k)/Math.sqrt(n*n+u*u);(d=0<=d*u-n*k?1-v:3+v)<g&&(g=d,e=c)}return e}var e=d(b,c),k=d(c,b),e=e.segOut,k=k.segOut,n=1==this.compare_pts_yx(b,c),g=this.appendSegmentEntry({vFrom:b,vTo:c,upward:!n,mprev:e.mprev,mnext:k}),n=this.appendSegmentEntry({vFrom:c,
vTo:b,upward:n,mprev:k.mprev,mnext:e});e.mprev.mnext=g;k.mprev.mnext=n;e.mprev=n;k.mprev=g;this.appendVertexOutsegEntry(b,{segOut:g,vertTo:c});this.appendVertexOutsegEntry(c,{segOut:n,vertTo:b});this.monoSubPolyChains[a]=k;this.monoSubPolyChains.push(e);return this.monoSubPolyChains.length-1},unique_monotone_chains_max:function(){var a,b,c,d,e,k;for(k=0;k<this.segments.length;k++)this.segments[k].marked=!1;var n=[];for(k=0;k<this.monoSubPolyChains.length;k++){a=b=this.monoSubPolyChains[k];d=e=a.vFrom;
a.marked=!0;a=a.mnext;for(var g=!1;(c=a.vFrom)!=d;){if(a.marked){g=!0;break}else a.marked=!0;1==this.compare_pts_yx(c,e)&&(e=c,b=a);a=a.mnext}g||n.push(b)}return n},normalize_monotone_chains:function(){this.monoSubPolyChains=this.unique_monotone_chains_max();return this.monoSubPolyChains.length},clearTriangles:function(){this.triangles=[]},addTriangle:function(a,b,c){this.triangles.push([a.id,b.id,c.id])}};PNLTRI.TRAP_MIDDLE=0;PNLTRI.TRAP_LEFT=1;PNLTRI.TRAP_RIGHT=2;PNLTRI.TRAP_CUSP=3;PNLTRI.trapCnt=0;PNLTRI.Trapezoid=function(a,b,c,d){this.trapID=PNLTRI.trapCnt++;this.vHigh=a?a:{x:Number.POSITIVE_INFINITY,y:Number.POSITIVE_INFINITY};this.vLow=b?b:{x:Number.NEGATIVE_INFINITY,y:Number.NEGATIVE_INFINITY};this.lseg=c;this.rseg=d;this.depth=-1;this.monoDiag=null};
PNLTRI.Trapezoid.prototype={constructor:PNLTRI.Trapezoid,clone:function(){var a=new PNLTRI.Trapezoid(this.vHigh,this.vLow,this.lseg,this.rseg);a.u0=this.u0;a.u1=this.u1;a.topLoc=this.topLoc;a.d0=this.d0;a.d1=this.d1;a.botLoc=this.botLoc;a.sink=this.sink;return a},setAbove:function(a,b){""!=a&&(this.u0=a);""!=b&&(this.u1=b)},setBelow:function(a,b){""!=a&&(this.d0=a);""!=b&&(this.d1=b)},setSink:function(a){this.sink=a},replaceAbove:function(a,b){this.u0==a?this.u0=b:this.u1==a&&(this.u1=b)},splitOffLower:function(a){var b=
this.clone();this.vLow=b.vHigh=a;this.botLoc=b.topLoc=PNLTRI.TRAP_MIDDLE;this.setBelow(b,null);b.setAbove(this,null);b.d0&&b.d0.replaceAbove(this,b);b.d1&&b.d1.replaceAbove(this,b);return b}};PNLTRI.T_Y=1;PNLTRI.T_X=2;PNLTRI.T_SINK=3;PNLTRI.S_LEFT=1;PNLTRI.S_RIGHT=2;PNLTRI.qsCounter=0;PNLTRI.QsNode=function(a,b,c){this.qsNodeID=PNLTRI.qsCounter++;this.nodetype=a;c&&(a==PNLTRI.T_Y?this.yval=c:a==PNLTRI.T_X?this.seg=c:this.trap=c)};
PNLTRI.QsNode.prototype={constructor:PNLTRI.QsNode,newRight:function(a,b){return this.right=new PNLTRI.QsNode(a,this,b)},newLeft:function(a,b){return this.left=new PNLTRI.QsNode(a,this,b)}};
PNLTRI.QueryStructure=function(a){PNLTRI.trapCnt=0;PNLTRI.qsCounter=0;this.root=new PNLTRI.QsNode(PNLTRI.T_SINK,null,null);var b=new PNLTRI.Trapezoid(null,null,null,null);b.setSink(this.root);this.root.trap=b;this.trapArray=[b];this.segListArray=null;if(a){this.segListArray=a.getSegments();for(b=0;b<this.segListArray.length;b++)this.segListArray[b].rootFrom=this.segListArray[b].rootTo=this.root,this.segListArray[b].is_inserted=!1;this.compare_pts_yx=a.compare_pts_yx}else this.compare_pts_yx=(new PNLTRI.PolygonData(null)).compare_pts_yx};
PNLTRI.QueryStructure.prototype={constructor:PNLTRI.QueryStructure,getRoot:function(){return this.root},getSegListArray:function(){return this.segListArray},cloneTrap:function(a){a=a.clone();this.trapArray.push(a);return a},splitNodeAtPoint:function(a,b,c){var d=a.trap;if(d.vHigh==b||d.vLow==b)return a;var e=d.splitOffLower(b);this.trapArray.push(e);a.nodetype=PNLTRI.T_Y;a.yval=b;a.trap=null;d.sink=a.newRight(PNLTRI.T_SINK,d);e.sink=a.newLeft(PNLTRI.T_SINK,e);return c?d.sink:e.sink},fpEqual:function(a,
b){return Math.abs(a-b)<PNLTRI.Math.EPSILON_P},inside_polygon:function(a){var b=a.rseg;return a.lseg&&a.rseg?!a.u0&&!a.u1||!a.d0&&!a.d1?b.upward:!1:!1},is_left_of:function(a,b,c){c=a.vFrom.x-b.x;var d=a.vTo.x-b.x;if(Math.abs(a.vTo.y-b.y)<PNLTRI.Math.EPSILON_P)a=d,b=c;else if(Math.abs(a.vFrom.y-b.y)<PNLTRI.Math.EPSILON_P)a=c,b=d;else return a.upward?PNLTRI.Math.ptsCrossProd(a.vFrom,a.vTo,b):PNLTRI.Math.ptsCrossProd(a.vTo,a.vFrom,b);return Math.abs(a)<PNLTRI.Math.EPSILON_P?Math.abs(b)<PNLTRI.Math.EPSILON_P?
0:b:a},ptNode:function(a,b,c){var d,e=!0;switch(c.nodetype){case PNLTRI.T_SINK:return c;case PNLTRI.T_Y:d=a;d==c.yval&&(d=b);d=this.compare_pts_yx(d,c.yval);-1==d&&(e=!1);break;case PNLTRI.T_X:if(a==c.seg.vFrom||a==c.seg.vTo){if(this.fpEqual(a.y,b.y)){b.x<a.x&&(e=!1);break}else d=this.is_left_of(c.seg,b,!1),0<d?e=!1:0==d&&(e=a==c.seg.vFrom?!0:!1);break}else d=this.is_left_of(c.seg,a,!0),0<d?e=!1:0==d&&(e=!0);break;default:console.log("ptNode: undef. NodeType: ",c.nodetype)}return e?this.ptNode(a,
b,c.right):this.ptNode(a,b,c.left)},add_segment:function(a){function b(a){f.vLow==q.vLow&&r?f.rseg==p?(l.setBelow(a,null),l.botLoc=PNLTRI.TRAP_RIGHT,m.botLoc=PNLTRI.TRAP_CUSP,m.setBelow(null,null),a.setAbove(l,"")):(m.setBelow(a,null),m.botLoc=PNLTRI.TRAP_LEFT,l.botLoc=PNLTRI.TRAP_CUSP,l.setBelow(null,null),a.setAbove("",m)):(a.u0&&a.u1?a.u0==f?(a.usave=a.u1,a.uside=PNLTRI.S_LEFT):(a.usave=a.u0,a.uside=PNLTRI.S_RIGHT):f.vLow==q.vLow&&(a.topLoc=PNLTRI.TRAP_MIDDLE,l.botLoc=PNLTRI.TRAP_RIGHT,m.botLoc=
PNLTRI.TRAP_LEFT),a.setAbove(l,m),l.setBelow(a,null),m.setBelow(a,null))}function c(){var b;f.vLow==q.vLow&&r?(f.d0.setAbove(l,null),f.d1.setAbove(m,null),b=f.d1,l.setBelow(f.d0,null),m.setBelow(b,null),l.botLoc=PNLTRI.TRAP_RIGHT,m.botLoc=PNLTRI.TRAP_LEFT,b=null):0<d.is_left_of(a,f.vLow,!0)?(b=f.d1,f.d0.setAbove(l,null),f.d1.setAbove(l,m),l.setBelow(f.d0,f.d1),m.setBelow(f.d1,null)):(b=f.d0,f.d0.setAbove(l,m),f.d1.setAbove(m,null),m.setBelow(f.d0,f.d1),l.setBelow(f.d0,null));return b}var d=this,e,
k,n,g,h,p;a.upward?(g=a.vFrom,e=a.vTo,h=a.rootFrom,k=a.rootTo,p=a.sprev,n=a.snext):(g=a.vTo,e=a.vFrom,h=a.rootTo,k=a.rootFrom,p=a.snext,n=a.sprev);var r=!1;k=this.ptNode(e,g,k);n.is_inserted||(k=this.splitNodeAtPoint(k,e,!1));n=k.trap;k=this.ptNode(g,e,h);p.is_inserted?r=!0:k=this.splitNodeAtPoint(k,g,!0);var q=k.trap,f=n,l,m,s,t;for(e=this.trapArray.length+2;f;){if(0>--e){console.log("ERR add_segment: infinite loop",f,a,this);return}if(!f.d0&&!f.d1){console.log("ERR add_segment: missing successors",
f,a,this);return}g=f.sink;g.nodetype=PNLTRI.T_X;g.seg=a;g.trap=null;h=k=!0;t&&t.rseg==f.rseg?(k=!1,l=f,m=t,m.vLow=f.vLow,m.botLoc=f.botLoc,g.right=t.sink,l.sink=g.newLeft(PNLTRI.T_SINK,l)):s&&s.lseg==f.lseg?(h=!1,m=f,l=s,l.vLow=f.vLow,l.botLoc=f.botLoc,g.left=s.sink,m.sink=g.newRight(PNLTRI.T_SINK,m)):(l=f,m=this.cloneTrap(f),m.sink=g.newRight(PNLTRI.T_SINK,m),l.sink=g.newLeft(PNLTRI.T_SINK,l));f.u0&&f.u1?f.usave?(f.uside==PNLTRI.S_LEFT?(m.setAbove(f.u1,f.usave),m.u0.setBelow(m,null),m.u1.setBelow(m,
null),m.topLoc=PNLTRI.TRAP_MIDDLE):(l.setAbove(f.usave,f.u0),l.u0.setBelow(l,null),l.u1.setBelow(l,null),l.topLoc=PNLTRI.TRAP_MIDDLE),l.usave=m.usave=null):(k&&(m.setAbove(f.u1,null),m.u0.setBelow(m,""),f.vHigh==n.vHigh&&(m.topLoc=PNLTRI.TRAP_LEFT)),h&&(l.setAbove(f.u0,null),f.vHigh==n.vHigh&&(l.topLoc=PNLTRI.TRAP_RIGHT))):f.u0.d0&&f.u0.d1?f==f.u0.d1?(l.setAbove(null,null),l.topLoc=PNLTRI.TRAP_CUSP,m.topLoc=PNLTRI.TRAP_LEFT,m.setAbove("",null),m.u0.setBelow("",m)):(m.setAbove(null,null),m.topLoc=
PNLTRI.TRAP_CUSP,l.topLoc=PNLTRI.TRAP_RIGHT,l.setAbove("",null),l.u0.setBelow(l,"")):(l.u0.setBelow(l,m),l.u0.botLoc=PNLTRI.TRAP_MIDDLE,l.topLoc=PNLTRI.TRAP_RIGHT,m.topLoc=PNLTRI.TRAP_LEFT);f.d0&&f.d1?g=c():(g=f.d0?f.d0:f.d1,b(g));l.rseg=m.lseg=a;f.vLow!=q.vLow?(s=l,t=m,f=g):f=null}a.is_inserted=!0},find_first_inside:function(){for(var a=0,b=this.trapArray.length;a<b;a++)if(this.inside_polygon(this.trapArray[a]))return this.trapArray[a];return null}};
PNLTRI.Trapezoider=function(a){this.polyData=a;this.queryStructure=new PNLTRI.QueryStructure(this.polyData)};
PNLTRI.Trapezoider.prototype={constructor:PNLTRI.Trapezoider,math_logstar_n:function(a){var b;for(b=0;1<=a;b++)a=PNLTRI.Math.log2(a);return b-1},math_NH:function(a,b){var c,d;c=0;for(d=a;c<b;c++)d=PNLTRI.Math.log2(d);return Math.ceil(1*a/d)},find_new_roots:function(a){a.is_inserted||(a.rootFrom=this.queryStructure.ptNode(a.vFrom,a.vTo,a.rootFrom),a.rootTo=this.queryStructure.ptNode(a.vTo,a.vFrom,a.rootTo))},trapezoide_polygon:function(){var a=this.queryStructure.segListArray.slice(0);PNLTRI.Math.array_shuffle(a);
var b,c,d=a.length,e=this.math_logstar_n(d);for(c=1;c<=e;c++){for(b=this.math_NH(d,c-1);b<this.math_NH(d,c);b++)this.queryStructure.add_segment(a[b-1]);for(b=0;b<d;b++)this.find_new_roots(a[b])}for(b=this.math_NH(d,e);b<=d;b++)this.queryStructure.add_segment(a[b-1]);return this.queryStructure.find_first_inside()}};PNLTRI.TRAP_NOSPLIT=-1;PNLTRI.MonoSplitter=function(a){this.polyData=a;this.startTrap=this.trapezoider=null};
PNLTRI.MonoSplitter.prototype={constructor:PNLTRI.MonoSplitter,monotonate_trapezoids:function(){this.trapezoider=new PNLTRI.Trapezoider(this.polyData);this.startTrap=this.trapezoider.trapezoide_polygon();this.polyData.initMonoChains();this.alyTrap(0,this.startTrap,null,null,null);return this.polyData.normalize_monotone_chains()},doSplit:function(a,b,c,d){return d?this.polyData.splitPolygonChain(a,b,c):this.polyData.splitPolygonChain(a,c,b)},alyTrap:function(a,b,c,d,e){function k(a){for(var b=a.length-
1;0<=b;b--)n.unshift(a[b])}var n=[],g=[];null==c&&(d=!0,b.u0?c=!0:b.d0?c=!1:(d=!1,c=b.u1?!0:!1));for(k([[b,c,d,a]]);g=n.shift();){var h;if((h=g[0])&&!h.monoDiag){if(!h.lseg||!h.rseg)return console.log("ERR alyTrap: lseg/rseg missing",h),h.monoDiag=PNLTRI.TRAP_NOSPLIT,n;a=g[1];b=g[2];var g=g[3],p;p=h.vHigh;var r=h.vLow,q=null,f,l;h.topLoc==PNLTRI.TRAP_MIDDLE&&(q=!0,f=h.u0,l=h.u1);h.botLoc==PNLTRI.TRAP_MIDDLE&&(q=!1,f=h.d0,l=h.d1);h.monoDiag=1+4*h.topLoc+h.botLoc;null!=q?h.topLoc==PNLTRI.TRAP_CUSP||
h.botLoc==PNLTRI.TRAP_CUSP?(p=this.doSplit(g,r,p,b),k([[b?f:l,!a,b,g],[b?l:f,!a,!b,p]])):h.topLoc==PNLTRI.TRAP_MIDDLE&&h.botLoc==PNLTRI.TRAP_MIDDLE?(p=this.doSplit(g,r,p,b),b||(a=p,p=g,g=a),k([[h.u0,!1,!0,g],[h.d0,!0,!0,g],[h.u1,!1,!1,p],[h.d1,!0,!1,p]])):(q?(c=h.d0?h.d0:h.d1,d=h.botLoc==PNLTRI.TRAP_LEFT):(c=h.u0?h.u0:h.u1,d=h.topLoc==PNLTRI.TRAP_LEFT),a==q&&b==d?g=this.doSplit(g,r,p,d):(p=this.doSplit(g,r,p,!d),k([[d?f:l,!q,d,p]])),k([[d?l:f,!q,!d,g],[c,q,!d,g]])):(h.topLoc==PNLTRI.TRAP_CUSP||h.botLoc==
PNLTRI.TRAP_CUSP?h.monoDiag=PNLTRI.TRAP_NOSPLIT:(h.topLoc==h.botLoc?h.monoDiag=PNLTRI.TRAP_NOSPLIT:g=h.topLoc==PNLTRI.TRAP_LEFT?this.doSplit(g,r,p,!a):this.doSplit(g,r,p,a),a=!a),a?(c=h.u0?h.u0:h.u1,d=h.topLoc==PNLTRI.TRAP_LEFT):(c=h.d0?h.d0:h.d1,d=h.botLoc==PNLTRI.TRAP_LEFT),k([[c,!a,!d,g]]))}if(e)return n}return[]}};PNLTRI.MonoTriangulator=function(a){this.polyData=a};
PNLTRI.MonoTriangulator.prototype={constructor:PNLTRI.MonoTriangulator,triangulate_all_polygons:function(){var a=this.polyData.getMonoSubPolys();this.polyData.clearTriangles();for(var b=0;b<a.length;b++){var c=a[b],d=c.mprev,e=c.mnext;e.mnext==d?this.polyData.addTriangle(c.vFrom,e.vFrom,d.vFrom):this.triangulate_single_polygon(c)}},triangulate_single_polygon:function(a){var b=a.mnext;a=a.vFrom;for(var c=[b.vFrom],d=0,b=b.mnext,e=b.vFrom;e!=a||1<d;)if(0<d)if(0<PNLTRI.Math.ptsCrossProd(e,c[d-1],c[d]))this.polyData.addTriangle(c[d-
1],c[d],e),d--;else if(c[++d]=e,e==a)for(console.log("ERR uni-y-monotone: only concave angles left",c);1<d;)d--,this.polyData.addTriangle(c[d-1],c[d],c[d+1]);else b=b.mnext,e=b.vFrom;else c[++d]=e,b=b.mnext,e=b.vFrom;this.polyData.addTriangle(c[d-1],c[d],e)}};PNLTRI.Triangulator=function(){this.lastPolyData=null};PNLTRI.Triangulator.prototype={constructor:PNLTRI.Triangulator,triangulate_polygon:function(a){if(!a||0==a.length)return[];a=new PNLTRI.PolygonData(a);(new PNLTRI.MonoSplitter(a)).monotonate_trapezoids();(new PNLTRI.MonoTriangulator(a)).triangulate_all_polygons();this.lastPolyData=a;return a.getTriangles()}};
