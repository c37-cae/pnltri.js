// pnltri.js / raw.github.com/jahting/pnltri.js/master/LICENSE
'use strict';var PNLTRI={REVISION:"0.8"};PNLTRI.Math={log2:function(a){return Math.log(a)/Math.LN2},random:Math.random,array_shuffle:function(a){for(var b=a.length-1;0<b;b--){var c=Math.floor(PNLTRI.Math.random()*(b+1)),d=a[b];a[b]=a[c];a[c]=d}return a},ptsCrossProd:function(a,b,c){return(b.x-a.x)*(c.y-a.y)-(b.y-a.y)*(c.x-a.x)}};PNLTRI.Math.EPSILON_P=Math.pow(2,-43);PNLTRI.Math.EPSILON_N=-PNLTRI.Math.EPSILON_P;PNLTRI.PolygonData=function(a){this.vertices=[];this.segments=[];this.monoSubPolyChains=[];this.triangles=[];if(a){this.addPolygonChain(a[0],!1);for(var b=1,c=a.length;b<c;b++)this.addPolygonChain(a[b],!0)}};
PNLTRI.PolygonData.prototype={constructor:PNLTRI.PolygonData,getSegments:function(){return this.segments},getMonoSubPolys:function(){return this.monoSubPolyChains},getTriangles:function(){return this.triangles.concat()},compare_pts_yx:function(a,b){var c=a.y-b.y;if(c>PNLTRI.Math.EPSILON_P)return 1;if(c<PNLTRI.Math.EPSILON_N)return-1;c=a.x-b.x;return c>PNLTRI.Math.EPSILON_P?1:c<PNLTRI.Math.EPSILON_N?-1:0},polygon_area:function(a){for(var b=a.length,c=0,d=b-1,e=0;e<b;d=e++)c+=a[d].x*a[e].y-a[e].x*a[d].y;
return 0.5*c},appendVertexEntry:function(a){a=a?a:{x:null,y:null,outSegs:[]};a.id=this.vertices.length;this.vertices.push(a);return a},createSegmentEntry:function(a,b){return{vFrom:a,vTo:b,upward:1==this.compare_pts_yx(b,a),sprev:null,snext:null}},appendSegmentEntry:function(a){this.segments.push(a);0==this.monoSubPolyChains.length&&(this.monoSubPolyChains=[this.segments[0]]);return a},addVertexChain:function(a,b){function c(a,b){return Math.abs(a.x-b.x)<PNLTRI.Math.EPSILON_P&&Math.abs(a.y-b.y)<PNLTRI.Math.EPSILON_P}
var d=!1;null!=b&&(d=0>this.polygon_area(a),d=b!=d);for(var e=[],n,k,m,l=0;l<a.length;l++)n=this.appendVertexEntry({x:a[l].x,y:a[l].y}),k=!0,m=e.length-1,0<=m&&c(n,e[m])&&(k=!1),k&&e.push(n);1<e.length&&c(e[e.length-1],e[0])&&e.pop();d&&(e=e.reverse());return e},addPolygonChain:function(a,b){var c=this.addVertexChain(a,b);if(3>c.length)return console.log("Polygon has < 3 vertices!",c),0;for(var d=this.segments.length,e,n,k,m=0;m<c.length-1;m++)e=this.createSegmentEntry(c[m],c[m+1]),k?(e.sprev=k,k.snext=
e):n=e,k=e,this.appendSegmentEntry(e);e=this.createSegmentEntry(c[c.length-1],c[0]);e.sprev=k;k.snext=e;this.appendSegmentEntry(e);n.sprev=e;e.snext=n;return this.segments.length-d},initMonoChains:function(){for(var a=0;a<this.segments.length;a++)this.segments[a].marked=!1,this.segments[a].mprev=this.segments[a].sprev,this.segments[a].mnext=this.segments[a].snext,this.segments[a].vFrom.outSegs=[{segOut:this.segments[a],vertTo:this.segments[a].vTo}]},appendVertexOutsegEntry:function(a,b){var c=b?b:
{segOut:null,vertTo:null};a.outSegs.push(c);return c},splitPolygonChain:function(a,b,c){function d(a,b){for(var c,d,e=null,g=4,h=0;h<a.outSegs.length;h++){c=a.outSegs[h];var k=c.vertTo;d=k.x-a.x;var k=k.y-a.y,m=b.x-a.x,u=b.y-a.y,n=(d*m+k*u)/Math.sqrt(d*d+k*k)/Math.sqrt(m*m+u*u);(d=0<=d*u-m*k?1-n:3+n)<g&&(g=d,e=c)}return e}var e=d(b,c),n=d(c,b),e=e.segOut,n=n.segOut,k=1==this.compare_pts_yx(b,c),m=this.appendSegmentEntry({vFrom:b,vTo:c,upward:!k,mprev:e.mprev,mnext:n}),k=this.appendSegmentEntry({vFrom:c,
vTo:b,upward:k,mprev:n.mprev,mnext:e});e.mprev.mnext=m;n.mprev.mnext=k;e.mprev=k;n.mprev=m;this.appendVertexOutsegEntry(b,{segOut:m,vertTo:c});this.appendVertexOutsegEntry(c,{segOut:k,vertTo:b});this.monoSubPolyChains[a]=n;this.monoSubPolyChains.push(e);return this.monoSubPolyChains.length-1},unique_monotone_chains_max:function(){var a,b,c,d,e,n;for(n=0;n<this.segments.length;n++)this.segments[n].marked=!1;var k=[];for(n=0;n<this.monoSubPolyChains.length;n++){a=b=this.monoSubPolyChains[n];d=e=a.vFrom;
a.marked=!0;a=a.mnext;for(var m=!1;(c=a.vFrom)!=d;){if(a.marked){m=!0;break}else a.marked=!0;1==this.compare_pts_yx(c,e)&&(e=c,b=a);a=a.mnext}m||k.push(b)}return k},normalize_monotone_chains:function(){this.monoSubPolyChains=this.unique_monotone_chains_max();return this.monoSubPolyChains.length},clearTriangles:function(){this.triangles=[]},addTriangle:function(a,b,c){this.triangles.push([a.id,b.id,c.id])}};PNLTRI.trapCnt=0;PNLTRI.Trapezoid=function(a,b,c,d){this.trapID=PNLTRI.trapCnt++;this.vHigh=a?a:{x:Number.POSITIVE_INFINITY,y:Number.POSITIVE_INFINITY};this.vLow=b?b:{x:Number.NEGATIVE_INFINITY,y:Number.NEGATIVE_INFINITY};this.lseg=c;this.rseg=d;this.depth=-1;this.monoDiag=null};
PNLTRI.Trapezoid.prototype={constructor:PNLTRI.Trapezoid,clone:function(){var a=new PNLTRI.Trapezoid(this.vHigh,this.vLow,this.lseg,this.rseg);a.uL=this.uL;a.uR=this.uR;a.dL=this.dL;a.dR=this.dR;a.sink=this.sink;return a},setAbove:function(a,b){this.uL=a;this.uR=b},setBelow:function(a,b){this.dL=a;this.dR=b},splitOffLower:function(a){var b=this.clone();this.vLow=b.vHigh=a;this.setBelow(b,null);b.setAbove(this,null);b.dL&&(b.dL.uL=b);b.dR&&(b.dR.uR=b);return b}};PNLTRI.T_Y=1;PNLTRI.T_X=2;
PNLTRI.T_SINK=3;PNLTRI.S_LEFT=1;PNLTRI.S_RIGHT=2;PNLTRI.QsNode=function(a){this.nodetype=PNLTRI.T_SINK;this.trap=a;a.sink=this};PNLTRI.QsNode.prototype={constructor:PNLTRI.QsNode};
PNLTRI.QueryStructure=function(a){PNLTRI.trapCnt=0;var b=new PNLTRI.Trapezoid(null,null,null,null);this.root=new PNLTRI.QsNode(b);this.trapArray=[b];this.segListArray=null;if(a){this.segListArray=a.getSegments();for(b=0;b<this.segListArray.length;b++)this.segListArray[b].rootFrom=this.segListArray[b].rootTo=this.root,this.segListArray[b].is_inserted=!1;this.compare_pts_yx=a.compare_pts_yx}else this.compare_pts_yx=PNLTRI.PolygonData.prototype.compare_pts_yx};
PNLTRI.QueryStructure.prototype={constructor:PNLTRI.QueryStructure,getRoot:function(){return this.root},getSegListArray:function(){return this.segListArray},cloneTrap:function(a){a=a.clone();this.trapArray.push(a);return a},splitNodeAtPoint:function(a,b,c){var d=a.trap;if(d.vHigh==b||d.vLow==b)return a;var e=d.splitOffLower(b);this.trapArray.push(e);a.nodetype=PNLTRI.T_Y;a.yval=b;a.trap=null;a.right=new PNLTRI.QsNode(d);a.left=new PNLTRI.QsNode(e);return c?d.sink:e.sink},fpEqual:function(a,b){return Math.abs(a-
b)<PNLTRI.Math.EPSILON_P},inside_polygon:function(a){var b=a.rseg;return a.lseg&&a.rseg?!a.uL&&!a.uR||!a.dL&&!a.dR?b.upward:!1:!1},is_left_of:function(a,b,c){c=a.vFrom.x-b.x;var d=a.vTo.x-b.x;if(Math.abs(a.vTo.y-b.y)<PNLTRI.Math.EPSILON_P)a=d,b=c;else if(Math.abs(a.vFrom.y-b.y)<PNLTRI.Math.EPSILON_P)a=c,b=d;else return a.upward?PNLTRI.Math.ptsCrossProd(a.vFrom,a.vTo,b):PNLTRI.Math.ptsCrossProd(a.vTo,a.vFrom,b);return Math.abs(a)<PNLTRI.Math.EPSILON_P?Math.abs(b)<PNLTRI.Math.EPSILON_P?0:b:a},ptNode:function(a,
b,c){var d,e=!0;switch(c.nodetype){case PNLTRI.T_SINK:return c;case PNLTRI.T_Y:d=a;d==c.yval&&(d=b);d=this.compare_pts_yx(d,c.yval);-1==d&&(e=!1);break;case PNLTRI.T_X:if(a==c.seg.vFrom||a==c.seg.vTo){if(this.fpEqual(a.y,b.y)){b.x<a.x&&(e=!1);break}else d=this.is_left_of(c.seg,b,!1),0<d?e=!1:0==d&&(e=a==c.seg.vFrom?!0:!1);break}else d=this.is_left_of(c.seg,a,!0),0<d?e=!1:0==d&&(e=!0);break;default:console.log("ptNode: undef. NodeType: ",c.nodetype)}return e?this.ptNode(a,b,c.right):this.ptNode(a,
b,c.left)},add_segment:function(a){function b(){var a=f.uL||f.uR;a.dL&&a.dR?f==a.dR?(g.setAbove(null,null),h.setAbove(null,a),a.setBelow(a.dL,h)):(h.setAbove(null,null),g.setAbove(a,null),a.setBelow(g,a.dR)):(g.setAbove(a,null),h.setAbove(null,a),a.setBelow(g,h))}function c(a){f.vLow==r.vLow&&q?f.dL?(g.setBelow(a,null),h.setBelow(null,null),a.setAbove(g,a.uR)):(h.setBelow(null,a),g.setBelow(null,null),a.setAbove(a.uL,h)):(a.uL&&a.uR?a.uL==f?(a.usave=a.uR,a.uside=PNLTRI.S_LEFT,g.setBelow(a,null),h.setBelow(a,
null)):(a.usave=a.uL,a.uside=PNLTRI.S_RIGHT,g.setBelow(null,a),h.setBelow(null,a)):f.vLow==r.vLow?(g.setBelow(a,null),h.setBelow(null,a)):(g.setBelow(null,a),h.setBelow(a,null)),a.setAbove(g,h))}function d(){var b;f.vLow==r.vLow&&q?(f.dL.setAbove(g,null),f.dR.setAbove(null,h),b=f.dR,g.setBelow(f.dL,null),h.setBelow(null,b),b=null):0<e.is_left_of(a,f.vLow,!0)?(b=f.dR,f.dL.setAbove(g,null),f.dR.setAbove(g,h),g.setBelow(f.dL,f.dR),h.setBelow(null,f.dR)):(b=f.dL,f.dL.setAbove(g,h),f.dR.setAbove(null,
h),h.setBelow(f.dL,f.dR),g.setBelow(f.dL,null));return b}var e=this,n,k,m,l,p,q;a.upward?(l=a.vFrom,n=a.vTo,p=a.rootFrom,k=a.rootTo,q=a.sprev.is_inserted,m=a.snext.is_inserted):(l=a.vTo,n=a.vFrom,p=a.rootTo,k=a.rootFrom,q=a.snext.is_inserted,m=a.sprev.is_inserted);k=this.ptNode(n,l,k);m||(k=this.splitNodeAtPoint(k,n,!1));m=k.trap;k=this.ptNode(l,n,p);q||(k=this.splitNodeAtPoint(k,l,!0));var r=k.trap,f=m,g,h,s,t;for(n=this.trapArray.length+2;f;){if(0>--n){console.log("ERR add_segment: infinite loop",
f,a,this);return}if(!f.dL&&!f.dR){console.log("ERR add_segment: missing successors",f,a,this);return}k=f.sink;k.nodetype=PNLTRI.T_X;k.seg=a;k.trap=null;l=p=!0;t&&t.rseg==f.rseg?(p=!1,g=f,h=t,h.vLow=f.vLow,k.right=t.sink,k.left=new PNLTRI.QsNode(g)):s&&s.lseg==f.lseg?(l=!1,h=f,g=s,g.vLow=f.vLow,k.left=s.sink,k.right=new PNLTRI.QsNode(h)):(g=f,h=this.cloneTrap(f),k.right=new PNLTRI.QsNode(h),k.left=new PNLTRI.QsNode(g));f.uL&&f.uR?f.usave?(f.uside==PNLTRI.S_LEFT?(h.setAbove(f.uR,f.usave),h.uL.setBelow(h,
null),h.uR.setBelow(null,h)):(g.setAbove(f.usave,f.uL),g.uL.setBelow(g,null),g.uR.setBelow(null,g)),g.usave=h.usave=null):f.vHigh==m.vHigh?(h.setAbove(null,f.uR),h.uR.setBelow(null,h),g.setAbove(f.uL,null)):(p&&(h.setAbove(f.uR,null),h.uL.setBelow(h,h.uL.dR)),l&&g.setAbove(null,f.uL)):b();f.dL&&f.dR?l=d():(l=f.dL?f.dL:f.dR,c(l));g.rseg=h.lseg=a;f.vLow!=r.vLow?(s=g,t=h,f=l):f=null}a.is_inserted=!0},find_first_inside:function(){for(var a=0,b=this.trapArray.length;a<b;a++)if(this.inside_polygon(this.trapArray[a]))return this.trapArray[a];
return null}};PNLTRI.Trapezoider=function(a){this.polyData=a;this.queryStructure=new PNLTRI.QueryStructure(this.polyData)};
PNLTRI.Trapezoider.prototype={constructor:PNLTRI.Trapezoider,math_logstar_n:function(a){var b;for(b=0;1<=a;b++)a=PNLTRI.Math.log2(a);return b-1},math_NH:function(a,b){var c,d;c=0;for(d=a;c<b;c++)d=PNLTRI.Math.log2(d);return Math.ceil(1*a/d)},find_new_roots:function(a){a.is_inserted||(a.rootFrom=this.queryStructure.ptNode(a.vFrom,a.vTo,a.rootFrom),a.rootTo=this.queryStructure.ptNode(a.vTo,a.vFrom,a.rootTo))},trapezoide_polygon:function(){var a=this.queryStructure.segListArray.slice(0);PNLTRI.Math.array_shuffle(a);
var b,c,d=a.length,e=this.math_logstar_n(d);for(c=1;c<=e;c++){for(b=this.math_NH(d,c-1);b<this.math_NH(d,c);b++)this.queryStructure.add_segment(a[b-1]);for(b=0;b<d;b++)this.find_new_roots(a[b])}for(b=this.math_NH(d,e);b<=d;b++)this.queryStructure.add_segment(a[b-1]);return this.queryStructure.find_first_inside()}};PNLTRI.TRAP_NOSPLIT=-1;PNLTRI.TRAP_MIDDLE=0;PNLTRI.TRAP_LEFT=1;PNLTRI.TRAP_RIGHT=2;PNLTRI.TRAP_CUSP=3;PNLTRI.MonoSplitter=function(a){this.polyData=a;this.startTrap=this.trapezoider=null};
PNLTRI.MonoSplitter.prototype={constructor:PNLTRI.MonoSplitter,monotonate_trapezoids:function(){this.trapezoider=new PNLTRI.Trapezoider(this.polyData);this.startTrap=this.trapezoider.trapezoide_polygon();this.polyData.initMonoChains();this.alyTrap(0,this.startTrap,null,null,null);return this.polyData.normalize_monotone_chains()},doSplit:function(a,b,c,d){return d?this.polyData.splitPolygonChain(a,b,c):this.polyData.splitPolygonChain(a,c,b)},alyTrap:function(a,b,c,d,e){function n(a){for(var b=a.length-
1;0<=b;b--)k.push(a[b])}var k=[],m=[];null==c&&(d=!0,b.uL?c=!0:b.dL?c=!1:(d=!1,c=b.uR?!0:!1));for(n([[b,c,d,a]]);m=k.pop();){var l;if((l=m[0])&&!l.monoDiag){if(!l.lseg||!l.rseg)return console.log("ERR alyTrap: lseg/rseg missing",l),l.monoDiag=PNLTRI.TRAP_NOSPLIT,k;a=m[1];b=m[2];var m=m[3],p;p=l.vHigh;var q=l.vLow;d=null;var r,f,g,h;l.uL?l.uR?(d=!0,r=l.uL,f=l.uR,g=PNLTRI.TRAP_MIDDLE):g=PNLTRI.TRAP_RIGHT:g=l.uR?PNLTRI.TRAP_LEFT:PNLTRI.TRAP_CUSP;l.dL?l.dR?(d=!1,r=l.dL,f=l.dR,h=PNLTRI.TRAP_MIDDLE):h=
PNLTRI.TRAP_RIGHT:h=l.dR?PNLTRI.TRAP_LEFT:PNLTRI.TRAP_CUSP;l.monoDiag=1+4*g+h;null!=d?g==PNLTRI.TRAP_CUSP||h==PNLTRI.TRAP_CUSP?(p=this.doSplit(m,q,p,b),n([[b?r:f,!a,b,m],[b?f:r,!a,!b,p]])):g==PNLTRI.TRAP_MIDDLE&&h==PNLTRI.TRAP_MIDDLE?(p=this.doSplit(m,q,p,b),b||(a=p,p=m,m=a),n([[l.uL,!1,!0,m],[l.dL,!0,!0,m],[l.uR,!1,!1,p],[l.dR,!0,!1,p]])):(d?(c=l.dL?l.dL:l.dR,g=h==PNLTRI.TRAP_LEFT):(c=l.uL?l.uL:l.uR,g=g==PNLTRI.TRAP_LEFT),a==d&&b==g?m=this.doSplit(m,q,p,g):(p=this.doSplit(m,q,p,!g),n([[g?r:f,!d,
g,p]])),n([[g?f:r,!d,!g,m],[c,d,!g,m]])):(g==PNLTRI.TRAP_CUSP||h==PNLTRI.TRAP_CUSP?l.monoDiag=PNLTRI.TRAP_NOSPLIT:(g==h?l.monoDiag=PNLTRI.TRAP_NOSPLIT:m=g==PNLTRI.TRAP_LEFT?this.doSplit(m,q,p,!a):this.doSplit(m,q,p,a),a=!a),a?(c=l.uL?l.uL:l.uR,g=g==PNLTRI.TRAP_LEFT):(c=l.dL?l.dL:l.dR,g=h==PNLTRI.TRAP_LEFT),n([[c,!a,!g,m]]))}if(e)return k}return[]}};PNLTRI.MonoTriangulator=function(a){this.polyData=a};
PNLTRI.MonoTriangulator.prototype={constructor:PNLTRI.MonoTriangulator,triangulate_all_polygons:function(){var a=this.polyData.getMonoSubPolys();this.polyData.clearTriangles();for(var b=0;b<a.length;b++){var c=a[b],d=c.mprev,e=c.mnext;e.mnext==d?this.polyData.addTriangle(c.vFrom,e.vFrom,d.vFrom):this.triangulate_single_polygon(c)}},triangulate_single_polygon:function(a){var b=a.mnext;a=a.vFrom;for(var c=[b.vFrom],d=0,b=b.mnext,e=b.vFrom;e!=a||1<d;)if(0<d)if(0<PNLTRI.Math.ptsCrossProd(e,c[d-1],c[d]))this.polyData.addTriangle(c[d-
1],c[d],e),d--;else if(c[++d]=e,e==a)for(console.log("ERR uni-y-monotone: only concave angles left",c);1<d;)d--,this.polyData.addTriangle(c[d-1],c[d],c[d+1]);else b=b.mnext,e=b.vFrom;else c[++d]=e,b=b.mnext,e=b.vFrom;this.polyData.addTriangle(c[d-1],c[d],e)}};PNLTRI.Triangulator=function(){this.lastPolyData=null};PNLTRI.Triangulator.prototype={constructor:PNLTRI.Triangulator,triangulate_polygon:function(a){if(!a||0==a.length)return[];a=new PNLTRI.PolygonData(a);(new PNLTRI.MonoSplitter(a)).monotonate_trapezoids();(new PNLTRI.MonoTriangulator(a)).triangulate_all_polygons();this.lastPolyData=a;return a.getTriangles()}};
