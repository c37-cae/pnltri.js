// pnltri.js / raw.github.com/jahting/pnltri.js/master/LICENSE
'use strict';var PNLTRI={REVISION:"0.9"};PNLTRI.Math={log2:function(a){return Math.log(a)/Math.LN2},random:Math.random,array_shuffle:function(a){for(var c=a.length-1;0<c;c--){var b=Math.floor(PNLTRI.Math.random()*(c+1)),d=a[c];a[c]=a[b];a[b]=d}return a},ptsCrossProd:function(a,c,b){return(c.x-a.x)*(b.y-a.y)-(c.y-a.y)*(b.x-a.x)}};PNLTRI.Math.EPSILON_P=Math.pow(2,-43);PNLTRI.Math.EPSILON_N=-PNLTRI.Math.EPSILON_P;PNLTRI.PolygonData=function(a){this.vertices=[];this.segments=[];this.idNextPolyChain=0;this.monoSubPolyChains=[];this.triangles=[];if(a)for(var c=0,b=a.length;c<b;c++)this.addPolygonChain(a[c])};
PNLTRI.PolygonData.prototype={constructor:PNLTRI.PolygonData,getSegments:function(){return this.segments},getMonoSubPolys:function(){return this.monoSubPolyChains},getTriangles:function(){return this.triangles.concat()},nbPolyChains:function(){return this.idNextPolyChain},compare_pts_yx:function(a,c){var b=a.y-c.y;if(b>PNLTRI.Math.EPSILON_P)return 1;if(b<PNLTRI.Math.EPSILON_N)return-1;b=a.x-c.x;return b>PNLTRI.Math.EPSILON_P?1:b<PNLTRI.Math.EPSILON_N?-1:0},appendVertexEntry:function(a){a=a?a:{x:null,
y:null,outSegs:[]};a.id=this.vertices.length;this.vertices.push(a);return a},createSegmentEntry:function(a,c){return{chainId:this.idNextPolyChain,vFrom:a,vTo:c,upward:1==this.compare_pts_yx(c,a),sprev:null,snext:null}},appendSegmentEntry:function(a){this.segments.push(a);0==this.monoSubPolyChains.length&&(this.monoSubPolyChains=[this.segments[0]]);return a},addVertexChain:function(a){function c(a,b){return Math.abs(a.x-b.x)<PNLTRI.Math.EPSILON_P&&Math.abs(a.y-b.y)<PNLTRI.Math.EPSILON_P}for(var b=
[],d,e,g,h=0;h<a.length;h++)d=this.appendVertexEntry({x:a[h].x,y:a[h].y}),e=!0,g=b.length-1,0<=g&&c(d,b[g])&&(e=!1),e&&b.push(d);1<b.length&&c(b[b.length-1],b[0])&&b.pop();return b},addPolygonChain:function(a){a=this.addVertexChain(a);if(3>a.length)return console.log("Polygon has < 3 vertices!",a),0;for(var c=this.segments.length,b,d,e,g=0;g<a.length-1;g++)b=this.createSegmentEntry(a[g],a[g+1]),e?(b.sprev=e,e.snext=b):d=b,e=b,this.appendSegmentEntry(b);b=this.createSegmentEntry(a[a.length-1],a[0]);
b.sprev=e;e.snext=b;this.appendSegmentEntry(b);d.sprev=b;b.snext=d;this.idNextPolyChain++;return this.segments.length-c},initMonoChains:function(){for(var a=0;a<this.segments.length;a++)this.segments[a].marked=!1,this.segments[a].mprev=this.segments[a].sprev,this.segments[a].mnext=this.segments[a].snext,this.segments[a].vFrom.outSegs=[{segOut:this.segments[a],vertTo:this.segments[a].vTo}]},appendVertexOutsegEntry:function(a,c){var b=c?c:{segOut:null,vertTo:null};a.outSegs.push(b);return b},splitPolygonChain:function(a,
c,b){function d(a,b){for(var c,d,f=null,e=4,k=0;k<a.outSegs.length;k++){c=a.outSegs[k];var g=c.vertTo;d=g.x-a.x;var g=g.y-a.y,l=b.x-a.x,v=b.y-a.y,h=(d*l+g*v)/Math.sqrt(d*d+g*g)/Math.sqrt(l*l+v*v);(d=0<=d*v-l*g?1-h:3+h)<e&&(e=d,f=c)}return f}var e=d(c,b),g=d(b,c),e=e.segOut,g=g.segOut,h=1==this.compare_pts_yx(c,b),l=this.appendSegmentEntry({vFrom:c,vTo:b,upward:!h,mprev:e.mprev,mnext:g}),h=this.appendSegmentEntry({vFrom:b,vTo:c,upward:h,mprev:g.mprev,mnext:e});e.mprev.mnext=l;g.mprev.mnext=h;e.mprev=
h;g.mprev=l;this.appendVertexOutsegEntry(c,{segOut:l,vertTo:b});this.appendVertexOutsegEntry(b,{segOut:h,vertTo:c});this.monoSubPolyChains[a]=g;this.monoSubPolyChains.push(e);return this.monoSubPolyChains.length-1},unique_monotone_chains_max:function(){var a,c,b,d,e,g;for(g=0;g<this.segments.length;g++)this.segments[g].marked=!1;var h=[];for(g=0;g<this.monoSubPolyChains.length;g++){a=c=this.monoSubPolyChains[g];d=e=a.vFrom;a.marked=!0;a=a.mnext;for(var l=!1;(b=a.vFrom)!=d;){if(a.marked){l=!0;break}else a.marked=
!0;1==this.compare_pts_yx(b,e)&&(e=b,c=a);a=a.mnext}l||h.push(c)}return h},normalize_monotone_chains:function(){this.monoSubPolyChains=this.unique_monotone_chains_max();return this.monoSubPolyChains.length},clearTriangles:function(){this.triangles=[]},addTriangle:function(a,c,b){this.triangles.push([a.id,c.id,b.id])}};PNLTRI.BasicTriangulator=function(a){this.polyData=a};
PNLTRI.BasicTriangulator.prototype={constructor:PNLTRI.BasicTriangulator,triangulate_single_polygon:function(a){function c(a,b,c,d,e){var f=a[b].x;b=a[b].y;var g=a[c].x;c=a[c].y;var k=a[d].x;d=a[d].y;if(PNLTRI.Math.EPSILON_P>(g-f)*(d-b)-(c-b)*(k-f))return!1;var h,u,v,B,C,D;h=k-g;u=d-c;v=f-k;B=b-d;C=g-f;D=c-b;var x,r,s,y,z,A,E;for(x=0;x<e;x++)if(r=a[x].x,s=a[x].y,!(r===f&&s===b||r===g&&s===c||r===k&&s===d)&&(y=r-f,z=s-b,A=r-g,E=s-c,r-=k,s-=d,A=h*E-u*A,y=C*z-D*y,z=v*s-B*r,A>=PNLTRI.Math.EPSILON_N&&
z>=PNLTRI.Math.EPSILON_N&&y>=PNLTRI.Math.EPSILON_N))return!1;return!0}a=function(a){var b=[],c=0,d=a,e,f,g=0;do e=d.sprev.vFrom,f=d.vFrom,c+=e.x*f.y-f.x*e.y,b[g++]=f,d=d.snext;while(d!=a);0>c&&(b=b.reverse());return b}(a);var b=a.length,d,e,g,h=2*b;for(e=b-1;2<b;){if(0>=h--)return!1;d=e;b<=d&&(d=0);e=d+1;b<=e&&(e=0);g=e+1;b<=g&&(g=0);if(c(a,d,e,g,b)){this.polyData.triangles.push([a[d].id,a[e].id,a[g].id]);d=e;for(g=e+1;g<b;d++,g++)a[d]=a[g];b--;h=2*b}}return!0}};PNLTRI.trapCnt=0;PNLTRI.Trapezoid=function(a,c,b,d){this.trapID=PNLTRI.trapCnt++;this.vHigh=a?a:{x:Number.POSITIVE_INFINITY,y:Number.POSITIVE_INFINITY};this.vLow=c?c:{x:Number.NEGATIVE_INFINITY,y:Number.NEGATIVE_INFINITY};this.lseg=b;this.rseg=d;this.depth=-1;this.monoDiag=null};
PNLTRI.Trapezoid.prototype={constructor:PNLTRI.Trapezoid,clone:function(){var a=new PNLTRI.Trapezoid(this.vHigh,this.vLow,this.lseg,this.rseg);a.uL=this.uL;a.uR=this.uR;a.dL=this.dL;a.dR=this.dR;a.sink=this.sink;return a},setAbove:function(a,c){this.uL=a;this.uR=c},setBelow:function(a,c){this.dL=a;this.dR=c},splitOffLower:function(a){var c=this.clone();this.vLow=c.vHigh=a;this.setBelow(c,null);c.setAbove(this,null);c.dL&&(c.dL.uL=c);c.dR&&(c.dR.uR=c);return c}};PNLTRI.T_Y=1;PNLTRI.T_X=2;
PNLTRI.T_SINK=3;PNLTRI.S_LEFT=1;PNLTRI.S_RIGHT=2;PNLTRI.QsNode=function(a){this.nodetype=PNLTRI.T_SINK;this.trap=a;a.sink=this};PNLTRI.QsNode.prototype={constructor:PNLTRI.QsNode};
PNLTRI.QueryStructure=function(a){PNLTRI.trapCnt=0;var c=new PNLTRI.Trapezoid(null,null,null,null);this.root=new PNLTRI.QsNode(c);this.trapArray=[c];this.segListArray=null;if(a){this.segListArray=a.getSegments();for(c=0;c<this.segListArray.length;c++)this.segListArray[c].rootFrom=this.segListArray[c].rootTo=this.root,this.segListArray[c].is_inserted=!1;this.compare_pts_yx=a.compare_pts_yx}else this.compare_pts_yx=PNLTRI.PolygonData.prototype.compare_pts_yx};
PNLTRI.QueryStructure.prototype={constructor:PNLTRI.QueryStructure,getRoot:function(){return this.root},getSegListArray:function(){return this.segListArray},cloneTrap:function(a){a=a.clone();this.trapArray.push(a);return a},splitNodeAtPoint:function(a,c,b){var d=a.trap;if(d.vHigh==c||d.vLow==c)return a;var e=d.splitOffLower(c);this.trapArray.push(e);a.nodetype=PNLTRI.T_Y;a.yval=c;a.trap=null;a.right=new PNLTRI.QsNode(d);a.left=new PNLTRI.QsNode(e);return b?d.sink:e.sink},fpEqual:function(a,c){return Math.abs(a-
c)<PNLTRI.Math.EPSILON_P},is_left_of:function(a,c,b){b=a.vFrom.x-c.x;var d=a.vTo.x-c.x;if(Math.abs(a.vTo.y-c.y)<PNLTRI.Math.EPSILON_P)a=d,c=b;else if(Math.abs(a.vFrom.y-c.y)<PNLTRI.Math.EPSILON_P)a=b,c=d;else return a.upward?PNLTRI.Math.ptsCrossProd(a.vFrom,a.vTo,c):PNLTRI.Math.ptsCrossProd(a.vTo,a.vFrom,c);return Math.abs(a)<PNLTRI.Math.EPSILON_P?Math.abs(c)<PNLTRI.Math.EPSILON_P?0:c:a},ptNode:function(a,c,b){var d,e=!0;switch(b.nodetype){case PNLTRI.T_SINK:return b;case PNLTRI.T_Y:d=a;d==b.yval&&
(d=c);d=this.compare_pts_yx(d,b.yval);-1==d&&(e=!1);break;case PNLTRI.T_X:if(a==b.seg.vFrom||a==b.seg.vTo){if(this.fpEqual(a.y,c.y)){c.x<a.x&&(e=!1);break}else d=this.is_left_of(b.seg,c,!1),0<d?e=!1:0==d&&(e=a==b.seg.vFrom?!0:!1);break}else d=this.is_left_of(b.seg,a,!0),0<d?e=!1:0==d&&(e=!0);break;default:console.log("ptNode: undef. NodeType: ",b.nodetype)}return e?this.ptNode(a,c,b.right):this.ptNode(a,c,b.left)},add_segment:function(a){function c(){var a=f.uL||f.uR;a.dL&&a.dR?f==a.dR?(m.setAbove(null,
null),k.setAbove(null,a),a.setBelow(a.dL,k)):(k.setAbove(null,null),m.setAbove(a,null),a.setBelow(m,a.dR)):(m.setAbove(a,null),k.setAbove(null,a),a.setBelow(m,k))}function b(a){f.vLow==t.vLow&&q?f.dL?(m.setBelow(a,null),k.setBelow(null,null),a.setAbove(m,a.uR)):(k.setBelow(null,a),m.setBelow(null,null),a.setAbove(a.uL,k)):(a.uL&&a.uR?a.uL==f?(a.usave=a.uR,a.uside=PNLTRI.S_LEFT,m.setBelow(a,null),k.setBelow(a,null)):(a.usave=a.uL,a.uside=PNLTRI.S_RIGHT,m.setBelow(null,a),k.setBelow(null,a)):f.vLow==
t.vLow?(m.setBelow(a,null),k.setBelow(null,a)):(m.setBelow(null,a),k.setBelow(a,null)),a.setAbove(m,k))}function d(){var b;f.vLow==t.vLow&&q?(f.dL.setAbove(m,null),f.dR.setAbove(null,k),b=f.dR,m.setBelow(f.dL,null),k.setBelow(null,b),b=null):0<e.is_left_of(a,f.vLow,!0)?(b=f.dR,f.dL.setAbove(m,null),f.dR.setAbove(m,k),m.setBelow(f.dL,f.dR),k.setBelow(null,f.dR)):(b=f.dL,f.dL.setAbove(m,k),f.dR.setAbove(null,k),k.setBelow(f.dL,f.dR),m.setBelow(f.dL,null));return b}var e=this,g,h,l,n,p,q;a.upward?(n=
a.vFrom,g=a.vTo,p=a.rootFrom,h=a.rootTo,q=a.sprev.is_inserted,l=a.snext.is_inserted):(n=a.vTo,g=a.vFrom,p=a.rootTo,h=a.rootFrom,q=a.snext.is_inserted,l=a.sprev.is_inserted);h=this.ptNode(g,n,h);l||(h=this.splitNodeAtPoint(h,g,!1));l=h.trap;if(l.uL||l.uR){h=this.ptNode(n,g,p);q||(h=this.splitNodeAtPoint(h,n,!0));var t=h.trap,f=l,m,k,w,u;for(g=this.trapArray.length+2;f;){if(0>--g){console.log("ERR add_segment: infinite loop",f,a,this);return}if(!f.dL&&!f.dR){console.log("ERR add_segment: missing successors",
f,a,this);return}h=f.sink;h.nodetype=PNLTRI.T_X;h.seg=a;h.trap=null;n=p=!0;u&&u.rseg==f.rseg?(p=!1,m=f,k=u,k.vLow=f.vLow,h.right=u.sink,h.left=new PNLTRI.QsNode(m)):w&&w.lseg==f.lseg?(n=!1,k=f,m=w,m.vLow=f.vLow,h.left=w.sink,h.right=new PNLTRI.QsNode(k)):(m=f,k=this.cloneTrap(f),h.right=new PNLTRI.QsNode(k),h.left=new PNLTRI.QsNode(m));f.uL&&f.uR?f.usave?(f.uside==PNLTRI.S_LEFT?(k.setAbove(f.uR,f.usave),k.uL.setBelow(k,null),k.uR.setBelow(null,k)):(m.setAbove(f.usave,f.uL),m.uL.setBelow(m,null),m.uR.setBelow(null,
m)),m.usave=k.usave=null):f.vHigh==l.vHigh?(k.setAbove(null,f.uR),k.uR.setBelow(null,k),m.setAbove(f.uL,null)):(p&&(k.setAbove(f.uR,null),k.uL.setBelow(k,k.uL.dR)),n&&m.setAbove(null,f.uL)):c();f.dL&&f.dR?n=d():(n=f.dL?f.dL:f.dR,b(n));m.rseg&&(m.rseg.trLeft=k);k.lseg&&(k.lseg.trRight=m);m.rseg=k.lseg=a;a.trLeft=m;a.trRight=k;f.vLow!=t.vLow?(w=m,u=k,f=n):f=null}a.is_inserted=!0}else console.log("ERR add_segment: missing trFirst.uX: ",l)},assignDepths:function(){var a=[this.trapArray[0]],c=[],b,d,e=
0;do{for(;b=a.pop();)-1==b.depth&&(b.depth=e,b.uL&&a.push(b.uL),b.uR&&a.push(b.uR),b.dL&&a.push(b.dL),b.dR&&a.push(b.dR),(d=b.lseg)&&-1==d.trLeft.depth&&c.push(d.trLeft),(d=b.rseg)&&-1==d.trRight.depth&&c.push(d.trRight));a=c;c=[];e++}while(0<a.length)},reverse_polygon_chain:function(a){var c,b=a;do c=b.snext,b.snext=b.sprev,b.sprev=c,c=b.vTo,b.vTo=b.vFrom,b.vFrom=c,b.upward=!b.upward,b=b.sprev;while(b!=a)},normalize_segment_orientation:function(){for(var a,c=0;c<this.segListArray.length;c++)a=this.segListArray[c],
a.upward==(0==a.trLeft.depth%2)&&this.reverse_polygon_chain(a)},find_first_inside:function(){for(var a,c=0,b=this.trapArray.length;c<b;c++)if(a=this.trapArray[c],1==a.depth%2&&!a.monoDiag&&(!a.uL&&!a.uR||!a.dL&&!a.dR))return a;return null}};PNLTRI.Trapezoider=function(a){this.polyData=a;this.queryStructure=new PNLTRI.QueryStructure(this.polyData)};
PNLTRI.Trapezoider.prototype={constructor:PNLTRI.Trapezoider,find_first_inside:function(){return this.queryStructure.find_first_inside()},math_logstar_n:function(a){var c;for(c=0;1<=a;c++)a=PNLTRI.Math.log2(a);return c-1},math_NH:function(a,c){var b,d;b=0;for(d=a;b<c;b++)d=PNLTRI.Math.log2(d);return Math.ceil(1*a/d)},optimise_randomlist:function(a){var c=0,b=this.polyData.nbPolyChains();if(1!=b)for(var d=Array(b),e=a.concat(),g=0;g<e.length;g++){var h=e[g].chainId;d[h]?a[b++]=e[g]:(a[c++]=e[g],d[h]=
!0)}},find_new_roots:function(a){a.is_inserted||(a.rootFrom=this.queryStructure.ptNode(a.vFrom,a.vTo,a.rootFrom),a.rootTo=this.queryStructure.ptNode(a.vTo,a.vFrom,a.rootTo))},trapezoide_polygon:function(){var a=this.queryStructure,c=a.segListArray.concat();PNLTRI.Math.array_shuffle(c);this.optimise_randomlist(c);var b,d,e=c.length,g=this.math_logstar_n(e);for(d=1;d<=g;d++){for(b=this.math_NH(e,d-1);b<this.math_NH(e,d);b++)a.add_segment(c[b-1]);for(b=0;b<e;b++)this.find_new_roots(c[b])}for(b=this.math_NH(e,
g);b<=e;b++)a.add_segment(c[b-1]);a.assignDepths();a.normalize_segment_orientation()}};PNLTRI.MonoSplitter=function(a){this.polyData=a;this.startTrap=this.trapezoider=null};
PNLTRI.MonoSplitter.prototype={constructor:PNLTRI.MonoSplitter,monotonate_trapezoids:function(){this.trapezoider=new PNLTRI.Trapezoider(this.polyData);this.trapezoider.trapezoide_polygon();this.startTrap=this.trapezoider.find_first_inside();this.polyData.initMonoChains();for(var a=0,c=this.startTrap;c;)if(this.polyData.monoSubPolyChains[a]=c.lseg,this.alyTrap(a,c,null,null,null),c=this.trapezoider.find_first_inside())a=this.polyData.monoSubPolyChains.length;return this.polyData.normalize_monotone_chains()},
doSplit:function(a,c,b,d){return d?this.polyData.splitPolygonChain(a,c,b):this.polyData.splitPolygonChain(a,b,c)},alyTrap:function(a,c,b,d,e){function g(){var a;return(a=h.pop())?(l=a[0],n=a[1],p=a[2],q=a[3],!0):!1}var h=[],l,n,p,q,t;null==b&&(d=!0,c.uL?b=!0:c.dL?b=!1:(d=!1,b=c.uR?!0:!1));for(c&&h.push([c,b,d,a]);g();)if(!l.monoDiag){if(!l.lseg||!l.rseg)return console.log("ERR alyTrap: lseg/rseg missing",l),h;n?p?(a=l.uL,c=l.uR,b=l.dL,d=l.dR):(a=l.uR,c=l.uL,b=l.dR,d=l.dL):p?(a=l.dL,c=l.dR,b=l.uL,
d=l.uR):(a=l.dR,c=l.dL,b=l.uR,d=l.uL);if(c||d)t=this.doSplit(q,l.vLow,l.vHigh,p);d&&h.push([d,n,!p,t]);c&&h.push([c,!n,!p,t]);b&&h.push([b,n,p,q]);b||d||a&&h.push([a,!n,p,q]);l.monoDiag=!0;if(e)return h}return[]}};PNLTRI.MonoTriangulator=function(a){this.polyData=a};
PNLTRI.MonoTriangulator.prototype={constructor:PNLTRI.MonoTriangulator,triangulate_all_polygons:function(){var a=this.polyData.getMonoSubPolys();this.polyData.clearTriangles();for(var c=0;c<a.length;c++){var b=a[c],d=b.mprev,e=b.mnext;e.mnext==d?this.polyData.addTriangle(b.vFrom,e.vFrom,d.vFrom):this.triangulate_single_polygon(b)}},triangulate_single_polygon:function(a){var c=a.mnext;a=a.vFrom;var b=[c.vFrom],d=0,c=c.mnext,e=c.vFrom;if(e!=a){for(;e!=a||1<d;)if(0<d)if(0<PNLTRI.Math.ptsCrossProd(e,
b[d-1],b[d]))this.polyData.addTriangle(b[d-1],b[d],e),d--;else if(b[++d]=e,e==a)for(console.log("ERR uni-y-monotone: only concave angles left",b);1<d;)d--,this.polyData.addTriangle(b[d-1],b[d],b[d+1]);else c=c.mnext,e=c.vFrom;else b[++d]=e,c=c.mnext,e=c.vFrom;this.polyData.addTriangle(b[d-1],b[d],e)}}};PNLTRI.Triangulator=function(){this.lastPolyData=null};PNLTRI.Triangulator.prototype={constructor:PNLTRI.Triangulator,triangulate_polygon:function(a){if(!a||0==a.length)return[];a=new PNLTRI.PolygonData(a);(new PNLTRI.MonoSplitter(a)).monotonate_trapezoids();(new PNLTRI.MonoTriangulator(a)).triangulate_all_polygons();this.lastPolyData=a;return a.getTriangles()}};
