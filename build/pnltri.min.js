// pnltri.js / raw.github.com/jahting/pnltri.js/master/LICENSE
'use strict';var PNLTRI={REVISION:"0.9"};PNLTRI.Math={log2:function(a){return Math.log(a)/Math.LN2},random:Math.random,array_shuffle:function(a){for(var b=a.length-1;0<b;b--){var c=Math.floor(PNLTRI.Math.random()*(b+1)),d=a[b];a[b]=a[c];a[c]=d}return a},ptsCrossProd:function(a,b,c){return(b.x-a.x)*(c.y-a.y)-(b.y-a.y)*(c.x-a.x)}};PNLTRI.Math.EPSILON_P=Math.pow(2,-43);PNLTRI.Math.EPSILON_N=-PNLTRI.Math.EPSILON_P;PNLTRI.PolygonData=function(a){this.vertices=[];this.segments=[];this.idNextPolyChain=0;this.monoSubPolyChains=[];this.triangles=[];if(a)for(var b=0,c=a.length;b<c;b++)this.addPolygonChain(a[b])};
PNLTRI.PolygonData.prototype={constructor:PNLTRI.PolygonData,getSegments:function(){return this.segments},getMonoSubPolys:function(){return this.monoSubPolyChains},getTriangles:function(){return this.triangles.concat()},nbPolyChains:function(){return this.idNextPolyChain},compare_pts_yx:function(a,b){var c=a.y-b.y;if(c>PNLTRI.Math.EPSILON_P)return 1;if(c<PNLTRI.Math.EPSILON_N)return-1;c=a.x-b.x;return c>PNLTRI.Math.EPSILON_P?1:c<PNLTRI.Math.EPSILON_N?-1:0},appendVertexEntry:function(a){a=a?a:{x:null,
y:null,outSegs:[]};a.id=this.vertices.length;this.vertices.push(a);return a},createSegmentEntry:function(a,b){return{chainId:this.idNextPolyChain,vFrom:a,vTo:b,upward:1==this.compare_pts_yx(b,a),sprev:null,snext:null}},appendSegmentEntry:function(a){this.segments.push(a);0==this.monoSubPolyChains.length&&(this.monoSubPolyChains=[this.segments[0]]);return a},addVertexChain:function(a){function b(a,b){return Math.abs(a.x-b.x)<PNLTRI.Math.EPSILON_P&&Math.abs(a.y-b.y)<PNLTRI.Math.EPSILON_P}for(var c=
[],d,e,g,k=0;k<a.length;k++)d=this.appendVertexEntry({x:a[k].x,y:a[k].y}),e=!0,g=c.length-1,0<=g&&b(d,c[g])&&(e=!1),e&&c.push(d);1<c.length&&b(c[c.length-1],c[0])&&c.pop();return c},addPolygonChain:function(a){a=this.addVertexChain(a);if(3>a.length)return console.log("Polygon has < 3 vertices!",a),0;for(var b=this.segments.length,c,d,e,g=0;g<a.length-1;g++)c=this.createSegmentEntry(a[g],a[g+1]),e?(c.sprev=e,e.snext=c):d=c,e=c,this.appendSegmentEntry(c);c=this.createSegmentEntry(a[a.length-1],a[0]);
c.sprev=e;e.snext=c;this.appendSegmentEntry(c);d.sprev=c;c.snext=d;this.idNextPolyChain++;return this.segments.length-b},initMonoChains:function(){for(var a=0;a<this.segments.length;a++)this.segments[a].marked=!1,this.segments[a].mprev=this.segments[a].sprev,this.segments[a].mnext=this.segments[a].snext,this.segments[a].vFrom.outSegs=[{segOut:this.segments[a],vertTo:this.segments[a].vTo}]},appendVertexOutsegEntry:function(a,b){var c=b?b:{segOut:null,vertTo:null};a.outSegs.push(c);return c},splitPolygonChain:function(a,
b,c){function d(a,b){for(var c,d,h=null,e=4,l=0;l<a.outSegs.length;l++){c=a.outSegs[l];var f=c.vertTo;d=f.x-a.x;var f=f.y-a.y,g=b.x-a.x,v=b.y-a.y,k=(d*g+f*v)/Math.sqrt(d*d+f*f)/Math.sqrt(g*g+v*v);(d=0<=d*v-g*f?1-k:3+k)<e&&(e=d,h=c)}return h}var e=d(b,c),g=d(c,b),e=e.segOut,g=g.segOut,k=1==this.compare_pts_yx(b,c),f=this.appendSegmentEntry({vFrom:b,vTo:c,upward:!k,mprev:e.mprev,mnext:g}),k=this.appendSegmentEntry({vFrom:c,vTo:b,upward:k,mprev:g.mprev,mnext:e});e.mprev.mnext=f;g.mprev.mnext=k;e.mprev=
k;g.mprev=f;this.appendVertexOutsegEntry(b,{segOut:f,vertTo:c});this.appendVertexOutsegEntry(c,{segOut:k,vertTo:b});this.monoSubPolyChains[a]=g;this.monoSubPolyChains.push(e);return this.monoSubPolyChains.length-1},unique_monotone_chains_max:function(){var a,b,c,d,e,g;for(g=0;g<this.segments.length;g++)this.segments[g].marked=!1;var k=[];for(g=0;g<this.monoSubPolyChains.length;g++){a=b=this.monoSubPolyChains[g];d=e=a.vFrom;a.marked=!0;a=a.mnext;for(var f=!1;(c=a.vFrom)!=d;){if(a.marked){f=!0;break}else a.marked=
!0;1==this.compare_pts_yx(c,e)&&(e=c,b=a);a=a.mnext}f||k.push(b)}return k},normalize_monotone_chains:function(){this.monoSubPolyChains=this.unique_monotone_chains_max();return this.monoSubPolyChains.length},clearTriangles:function(){this.triangles=[]},addTriangle:function(a,b,c){this.triangles.push([a.id,b.id,c.id])}};PNLTRI.BasicTriangulator=function(a){this.polyData=a};
PNLTRI.BasicTriangulator.prototype={constructor:PNLTRI.BasicTriangulator,triangulate_single_polygon:function(a,b){function c(a,b,c,d,e,f){var g,k,m,p,q,r;g=a[f[b]].x;b=a[f[b]].y;k=a[f[c]].x;c=a[f[c]].y;m=a[f[d]].x;p=a[f[d]].y;if(PNLTRI.Math.EPSILON_P>(k-g)*(p-b)-(c-b)*(m-g))return!1;var z,A,B,C,D,E,w,x,y,F;z=m-k;A=p-c;B=g-m;C=b-p;D=k-g;E=c-b;for(d=0;d<e;d++)if(q=a[f[d]].x,r=a[f[d]].y,!(q===g&&r===b||q===k&&r===c||q===m&&r===p)&&(w=q-g,x=r-b,y=q-k,F=r-c,q-=m,r-=p,y=z*F-A*y,w=D*x-E*w,x=B*r-C*q,y>=PNLTRI.Math.EPSILON_N&&
x>=PNLTRI.Math.EPSILON_N&&w>=PNLTRI.Math.EPSILON_N))return!1;return!0}var d=a.length,e=[],g=[],k=[],f,m,p;if(0<function(a){for(var b=a.length,c=0,d=b-1,e=0;e<b;d=e++)c+=a[d].x*a[e].y-a[e].x*a[d].y;return 0.5*c}(a))for(m=0;m<d;m++)g[m]=m;else for(m=0;m<d;m++)g[m]=d-1-m;var q=2*d;for(m=d-1;2<d;){if(0>=q--){console.log("Warning, unable to triangulate polygon!");break}f=m;d<=f&&(f=0);m=f+1;d<=m&&(m=0);p=m+1;d<=p&&(p=0);if(c(a,f,m,p,d,g)){f=g[f];q=g[m];p=g[p];e.push([a[f],a[q],a[p]]);this.polyData.triangles.push([f,
q,p]);p=m;for(f=m+1;f<d;p++,f++)g[p]=g[f];d--;q=2*d}}return b?k:e}};PNLTRI.trapCnt=0;PNLTRI.Trapezoid=function(a,b,c,d){this.trapID=PNLTRI.trapCnt++;this.vHigh=a?a:{x:Number.POSITIVE_INFINITY,y:Number.POSITIVE_INFINITY};this.vLow=b?b:{x:Number.NEGATIVE_INFINITY,y:Number.NEGATIVE_INFINITY};this.lseg=c;this.rseg=d;this.depth=-1;this.monoDiag=null};
PNLTRI.Trapezoid.prototype={constructor:PNLTRI.Trapezoid,clone:function(){var a=new PNLTRI.Trapezoid(this.vHigh,this.vLow,this.lseg,this.rseg);a.uL=this.uL;a.uR=this.uR;a.dL=this.dL;a.dR=this.dR;a.sink=this.sink;return a},setAbove:function(a,b){this.uL=a;this.uR=b},setBelow:function(a,b){this.dL=a;this.dR=b},splitOffLower:function(a){var b=this.clone();this.vLow=b.vHigh=a;this.setBelow(b,null);b.setAbove(this,null);b.dL&&(b.dL.uL=b);b.dR&&(b.dR.uR=b);return b}};PNLTRI.T_Y=1;PNLTRI.T_X=2;
PNLTRI.T_SINK=3;PNLTRI.S_LEFT=1;PNLTRI.S_RIGHT=2;PNLTRI.QsNode=function(a){this.nodetype=PNLTRI.T_SINK;this.trap=a;a.sink=this};PNLTRI.QsNode.prototype={constructor:PNLTRI.QsNode};
PNLTRI.QueryStructure=function(a){PNLTRI.trapCnt=0;var b=new PNLTRI.Trapezoid(null,null,null,null);this.root=new PNLTRI.QsNode(b);this.trapArray=[b];this.segListArray=null;if(a){this.segListArray=a.getSegments();for(b=0;b<this.segListArray.length;b++)this.segListArray[b].rootFrom=this.segListArray[b].rootTo=this.root,this.segListArray[b].is_inserted=!1;this.compare_pts_yx=a.compare_pts_yx}else this.compare_pts_yx=PNLTRI.PolygonData.prototype.compare_pts_yx};
PNLTRI.QueryStructure.prototype={constructor:PNLTRI.QueryStructure,getRoot:function(){return this.root},getSegListArray:function(){return this.segListArray},cloneTrap:function(a){a=a.clone();this.trapArray.push(a);return a},splitNodeAtPoint:function(a,b,c){var d=a.trap;if(d.vHigh==b||d.vLow==b)return a;var e=d.splitOffLower(b);this.trapArray.push(e);a.nodetype=PNLTRI.T_Y;a.yval=b;a.trap=null;a.right=new PNLTRI.QsNode(d);a.left=new PNLTRI.QsNode(e);return c?d.sink:e.sink},fpEqual:function(a,b){return Math.abs(a-
b)<PNLTRI.Math.EPSILON_P},is_left_of:function(a,b,c){c=a.vFrom.x-b.x;var d=a.vTo.x-b.x;if(Math.abs(a.vTo.y-b.y)<PNLTRI.Math.EPSILON_P)a=d,b=c;else if(Math.abs(a.vFrom.y-b.y)<PNLTRI.Math.EPSILON_P)a=c,b=d;else return a.upward?PNLTRI.Math.ptsCrossProd(a.vFrom,a.vTo,b):PNLTRI.Math.ptsCrossProd(a.vTo,a.vFrom,b);return Math.abs(a)<PNLTRI.Math.EPSILON_P?Math.abs(b)<PNLTRI.Math.EPSILON_P?0:b:a},ptNode:function(a,b,c){var d,e=!0;switch(c.nodetype){case PNLTRI.T_SINK:return c;case PNLTRI.T_Y:d=a;d==c.yval&&
(d=b);d=this.compare_pts_yx(d,c.yval);-1==d&&(e=!1);break;case PNLTRI.T_X:if(a==c.seg.vFrom||a==c.seg.vTo){if(this.fpEqual(a.y,b.y)){b.x<a.x&&(e=!1);break}else d=this.is_left_of(c.seg,b,!1),0<d?e=!1:0==d&&(e=a==c.seg.vFrom?!0:!1);break}else d=this.is_left_of(c.seg,a,!0),0<d?e=!1:0==d&&(e=!0);break;default:console.log("ptNode: undef. NodeType: ",c.nodetype)}return e?this.ptNode(a,b,c.right):this.ptNode(a,b,c.left)},add_segment:function(a){function b(){var a=h.uL||h.uR;a.dL&&a.dR?h==a.dR?(n.setAbove(null,
null),l.setAbove(null,a),a.setBelow(a.dL,l)):(l.setAbove(null,null),n.setAbove(a,null),a.setBelow(n,a.dR)):(n.setAbove(a,null),l.setAbove(null,a),a.setBelow(n,l))}function c(a){h.vLow==s.vLow&&q?h.dL?(n.setBelow(a,null),l.setBelow(null,null),a.setAbove(n,a.uR)):(l.setBelow(null,a),n.setBelow(null,null),a.setAbove(a.uL,l)):(a.uL&&a.uR?a.uL==h?(a.usave=a.uR,a.uside=PNLTRI.S_LEFT,n.setBelow(a,null),l.setBelow(a,null)):(a.usave=a.uL,a.uside=PNLTRI.S_RIGHT,n.setBelow(null,a),l.setBelow(null,a)):h.vLow==
s.vLow?(n.setBelow(a,null),l.setBelow(null,a)):(n.setBelow(null,a),l.setBelow(a,null)),a.setAbove(n,l))}function d(){var b;h.vLow==s.vLow&&q?(h.dL.setAbove(n,null),h.dR.setAbove(null,l),b=h.dR,n.setBelow(h.dL,null),l.setBelow(null,b),b=null):0<e.is_left_of(a,h.vLow,!0)?(b=h.dR,h.dL.setAbove(n,null),h.dR.setAbove(n,l),n.setBelow(h.dL,h.dR),l.setBelow(null,h.dR)):(b=h.dL,h.dL.setAbove(n,l),h.dR.setAbove(null,l),l.setBelow(h.dL,h.dR),n.setBelow(h.dL,null));return b}var e=this,g,k,f,m,p,q;a.upward?(m=
a.vFrom,g=a.vTo,p=a.rootFrom,k=a.rootTo,q=a.sprev.is_inserted,f=a.snext.is_inserted):(m=a.vTo,g=a.vFrom,p=a.rootTo,k=a.rootFrom,q=a.snext.is_inserted,f=a.sprev.is_inserted);k=this.ptNode(g,m,k);f||(k=this.splitNodeAtPoint(k,g,!1));f=k.trap;if(f.uL||f.uR){k=this.ptNode(m,g,p);q||(k=this.splitNodeAtPoint(k,m,!0));var s=k.trap,h=f,n,l,t,u;for(g=this.trapArray.length+2;h;){if(0>--g){console.log("ERR add_segment: infinite loop",h,a,this);return}if(!h.dL&&!h.dR){console.log("ERR add_segment: missing successors",
h,a,this);return}k=h.sink;k.nodetype=PNLTRI.T_X;k.seg=a;k.trap=null;m=p=!0;u&&u.rseg==h.rseg?(p=!1,n=h,l=u,l.vLow=h.vLow,k.right=u.sink,k.left=new PNLTRI.QsNode(n)):t&&t.lseg==h.lseg?(m=!1,l=h,n=t,n.vLow=h.vLow,k.left=t.sink,k.right=new PNLTRI.QsNode(l)):(n=h,l=this.cloneTrap(h),k.right=new PNLTRI.QsNode(l),k.left=new PNLTRI.QsNode(n));h.uL&&h.uR?h.usave?(h.uside==PNLTRI.S_LEFT?(l.setAbove(h.uR,h.usave),l.uL.setBelow(l,null),l.uR.setBelow(null,l)):(n.setAbove(h.usave,h.uL),n.uL.setBelow(n,null),n.uR.setBelow(null,
n)),n.usave=l.usave=null):h.vHigh==f.vHigh?(l.setAbove(null,h.uR),l.uR.setBelow(null,l),n.setAbove(h.uL,null)):(p&&(l.setAbove(h.uR,null),l.uL.setBelow(l,l.uL.dR)),m&&n.setAbove(null,h.uL)):b();h.dL&&h.dR?m=d():(m=h.dL?h.dL:h.dR,c(m));n.rseg&&(n.rseg.trLeft=l);l.lseg&&(l.lseg.trRight=n);n.rseg=l.lseg=a;a.trLeft=n;a.trRight=l;h.vLow!=s.vLow?(t=n,u=l,h=m):h=null}a.is_inserted=!0}else console.log("ERR add_segment: missing trFirst.uX: ",f)},assignDepths:function(){var a=[this.trapArray[0]],b=[],c,d,e=
0;do{for(;c=a.pop();)-1==c.depth&&(c.depth=e,c.uL&&a.push(c.uL),c.uR&&a.push(c.uR),c.dL&&a.push(c.dL),c.dR&&a.push(c.dR),(d=c.lseg)&&-1==d.trLeft.depth&&b.push(d.trLeft),(d=c.rseg)&&-1==d.trRight.depth&&b.push(d.trRight));a=b;b=[];e++}while(0<a.length)},reverse_polygon_chain:function(a){var b,c=a;do b=c.snext,c.snext=c.sprev,c.sprev=b,b=c.vTo,c.vTo=c.vFrom,c.vFrom=b,c.upward=!c.upward,c=c.sprev;while(c!=a)},normalize_segment_orientation:function(){for(var a,b=0;b<this.segListArray.length;b++)a=this.segListArray[b],
a.upward==(0==a.trLeft.depth%2)&&this.reverse_polygon_chain(a)},find_first_inside:function(){for(var a,b=0,c=this.trapArray.length;b<c;b++)if(a=this.trapArray[b],1==a.depth%2&&!a.monoDiag&&(!a.uL&&!a.uR||!a.dL&&!a.dR))return a;return null}};PNLTRI.Trapezoider=function(a){this.polyData=a;this.queryStructure=new PNLTRI.QueryStructure(this.polyData)};
PNLTRI.Trapezoider.prototype={constructor:PNLTRI.Trapezoider,find_first_inside:function(){return this.queryStructure.find_first_inside()},math_logstar_n:function(a){var b;for(b=0;1<=a;b++)a=PNLTRI.Math.log2(a);return b-1},math_NH:function(a,b){var c,d;c=0;for(d=a;c<b;c++)d=PNLTRI.Math.log2(d);return Math.ceil(1*a/d)},optimise_randomlist:function(a){var b=0,c=this.polyData.nbPolyChains();if(1!=c)for(var d=Array(c),e=a.concat(),g=0;g<e.length;g++){var k=e[g].chainId;d[k]?a[c++]=e[g]:(a[b++]=e[g],d[k]=
!0)}},find_new_roots:function(a){a.is_inserted||(a.rootFrom=this.queryStructure.ptNode(a.vFrom,a.vTo,a.rootFrom),a.rootTo=this.queryStructure.ptNode(a.vTo,a.vFrom,a.rootTo))},trapezoide_polygon:function(){var a=this.queryStructure,b=a.segListArray.concat();PNLTRI.Math.array_shuffle(b);this.optimise_randomlist(b);var c,d,e=b.length,g=this.math_logstar_n(e);for(d=1;d<=g;d++){for(c=this.math_NH(e,d-1);c<this.math_NH(e,d);c++)a.add_segment(b[c-1]);for(c=0;c<e;c++)this.find_new_roots(b[c])}for(c=this.math_NH(e,
g);c<=e;c++)a.add_segment(b[c-1]);a.assignDepths();a.normalize_segment_orientation()}};PNLTRI.MonoSplitter=function(a){this.polyData=a;this.startTrap=this.trapezoider=null};
PNLTRI.MonoSplitter.prototype={constructor:PNLTRI.MonoSplitter,monotonate_trapezoids:function(){this.trapezoider=new PNLTRI.Trapezoider(this.polyData);this.trapezoider.trapezoide_polygon();this.startTrap=this.trapezoider.find_first_inside();this.polyData.initMonoChains();for(var a=0,b=this.startTrap;b;)if(this.polyData.monoSubPolyChains[a]=b.lseg,this.alyTrap(a,b,null,null,null),b=this.trapezoider.find_first_inside())a=this.polyData.monoSubPolyChains.length;return this.polyData.normalize_monotone_chains()},
doSplit:function(a,b,c,d){return d?this.polyData.splitPolygonChain(a,b,c):this.polyData.splitPolygonChain(a,c,b)},alyTrap:function(a,b,c,d,e){function g(){var a;return(a=k.pop())?(f=a[0],m=a[1],p=a[2],q=a[3],!0):!1}var k=[],f,m,p,q,s;null==c&&(d=!0,b.uL?c=!0:b.dL?c=!1:(d=!1,c=b.uR?!0:!1));for(b&&k.push([b,c,d,a]);g();)if(!f.monoDiag){if(!f.lseg||!f.rseg)return console.log("ERR alyTrap: lseg/rseg missing",f),k;m?p?(a=f.uL,b=f.uR,c=f.dL,d=f.dR):(a=f.uR,b=f.uL,c=f.dR,d=f.dL):p?(a=f.dL,b=f.dR,c=f.uL,
d=f.uR):(a=f.dR,b=f.dL,c=f.uR,d=f.uL);if(b||d)s=this.doSplit(q,f.vLow,f.vHigh,p);d&&k.push([d,m,!p,s]);b&&k.push([b,!m,!p,s]);c&&k.push([c,m,p,q]);c||d||a&&k.push([a,!m,p,q]);f.monoDiag=!0;if(e)return k}return[]}};PNLTRI.MonoTriangulator=function(a){this.polyData=a};
PNLTRI.MonoTriangulator.prototype={constructor:PNLTRI.MonoTriangulator,triangulate_all_polygons:function(){var a=this.polyData.getMonoSubPolys();this.polyData.clearTriangles();for(var b=0;b<a.length;b++){var c=a[b],d=c.mprev,e=c.mnext;e.mnext==d?this.polyData.addTriangle(c.vFrom,e.vFrom,d.vFrom):this.triangulate_single_polygon(c)}},triangulate_single_polygon:function(a){var b=a.mnext;a=a.vFrom;var c=[b.vFrom],d=0,b=b.mnext,e=b.vFrom;if(e!=a){for(;e!=a||1<d;)if(0<d)if(0<PNLTRI.Math.ptsCrossProd(e,
c[d-1],c[d]))this.polyData.addTriangle(c[d-1],c[d],e),d--;else if(c[++d]=e,e==a)for(console.log("ERR uni-y-monotone: only concave angles left",c);1<d;)d--,this.polyData.addTriangle(c[d-1],c[d],c[d+1]);else b=b.mnext,e=b.vFrom;else c[++d]=e,b=b.mnext,e=b.vFrom;this.polyData.addTriangle(c[d-1],c[d],e)}}};PNLTRI.Triangulator=function(){this.lastPolyData=null};PNLTRI.Triangulator.prototype={constructor:PNLTRI.Triangulator,triangulate_polygon:function(a){if(!a||0==a.length)return[];a=new PNLTRI.PolygonData(a);(new PNLTRI.MonoSplitter(a)).monotonate_trapezoids();(new PNLTRI.MonoTriangulator(a)).triangulate_all_polygons();this.lastPolyData=a;return a.getTriangles()}};
