// pnltri.js / raw.github.com/jahting/pnltri.js/master/LICENSE
'use strict';var PNLTRI={REVISION:"1.4"};PNLTRI.Math={random:Math.random,array_shuffle:function(a){for(var b=a.length-1;0<b;b--){var c=Math.floor(PNLTRI.Math.random()*(b+1)),d=a[b];a[b]=a[c];a[c]=d}return a},ptsCrossProd:function(a,b,c){return(b.x-a.x)*(c.y-a.y)-(b.y-a.y)*(c.x-a.x)},vectorLength:function(a){return Math.sqrt(a.x*a.x+a.y*a.y)},dotProd:function(a,b){return a.x*b.x+a.y*b.y},crossProd:function(a,b){return a.x*b.y-b.x*a.y},mapAngle:function(a,b,c){b={x:b.x-a.x,y:b.y-a.y};a={x:c.x-a.x,y:c.y-a.y};c=PNLTRI.Math.dotProd(b,a)/PNLTRI.Math.vectorLength(b)/
PNLTRI.Math.vectorLength(a);return 0<=PNLTRI.Math.crossProd(b,a)?1-c:3+c},compare_pts_yx:function(a,b){var c=a.y-b.y;if(c<PNLTRI.Math.EPSILON_N)return-1;if(c>PNLTRI.Math.EPSILON_P)return 1;c=a.x-b.x;return c<PNLTRI.Math.EPSILON_N?-1:c>PNLTRI.Math.EPSILON_P?1:0}};PNLTRI.Math.EPSILON_P=Math.pow(2,-43);PNLTRI.Math.EPSILON_N=-PNLTRI.Math.EPSILON_P;PNLTRI.PolygonData=function(a){this.vertices=[];this.segments=[];this.idNextPolyChain=0;this.PolyLeftArr=[];this.monoSubPolyChains=[];this.triangles=[];if(a)for(var b=0,c=a.length;b<c;b++)this.addPolygonChain(a[b])};
PNLTRI.PolygonData.prototype={constructor:PNLTRI.PolygonData,getSegments:function(){return this.segments},getFirstSegment:function(){return this.segments[0]},getMonoSubPolys:function(){return this.monoSubPolyChains},getTriangles:function(){return this.triangles.concat()},nbPolyChains:function(){return this.idNextPolyChain},get_PolyLeftArr:function(){return this.PolyLeftArr.concat()},set_PolyLeft_wrong:function(a){this.PolyLeftArr[a]=!1},isClockWise:function(a){var b=a,c=0;do c+=(b.vFrom.x-b.vTo.x)*
(b.vFrom.y+b.vTo.y),b=b.snext;while(b!=a);return 0>c},appendVertexEntry:function(a,b){var c={id:this.vertices.length,x:a,y:b,outSegs:[]};this.vertices.push(c);return c},createSegmentEntry:function(a,b){return{chainId:this.idNextPolyChain,vFrom:a,vTo:b,upward:1==PNLTRI.Math.compare_pts_yx(b,a),sprev:null,snext:null,rootFrom:null,rootTo:null,is_inserted:!1,trLeft:null,trRight:null,mprev:null,mnext:null,marked:!1}},appendSegmentEntry:function(a){this.segments.push(a);return a},addVertexChain:function(a){function b(a,
b){return Math.abs(a.x-b.x)<PNLTRI.Math.EPSILON_P&&Math.abs(a.y-b.y)<PNLTRI.Math.EPSILON_P}for(var c=[],d,e,f,g=0;g<a.length;g++)d=this.appendVertexEntry(a[g].x,a[g].y),e=!0,f=c.length-1,0<=f&&b(d,c[f])&&(e=!1),e&&c.push(d);1<c.length&&b(c[c.length-1],c[0])&&c.pop();return c},addPolygonChain:function(a){a=this.addVertexChain(a);if(3>a.length)return console.log("Polygon has < 3 vertices!",a),0;for(var b=this.segments.length,c,d,e,f=0;f<a.length-1;f++)c=this.createSegmentEntry(a[f],a[f+1]),e?(c.sprev=
e,e.snext=c):d=c,e=c,this.appendSegmentEntry(c);c=this.createSegmentEntry(a[a.length-1],a[0]);c.sprev=e;e.snext=c;this.appendSegmentEntry(c);d.sprev=c;c.snext=d;this.PolyLeftArr[this.idNextPolyChain++]=!0;return this.segments.length-b},initMonoChains:function(){for(var a,b=0;b<this.segments.length;b++)a=this.segments[b],this.PolyLeftArr[a.chainId]?(a.mprev=a.sprev,a.mnext=a.snext,a.vFrom.outSegs.push({segOut:a,vertTo:a.vTo})):(a=a.snext,a.mprev=a.snext,a.mnext=a.sprev,a.vFrom.outSegs.push({segOut:a,
vertTo:this.segments[b].vFrom}))},createMonoSegment:function(a){this.appendSegmentEntry(a);a.vFrom.outSegs.push({segOut:a,vertTo:a.vTo});return a},newMonoChain:function(a){var b=this.monoSubPolyChains.length;this.monoSubPolyChains[b]=a;return b},get_out_segment_next_right_of:function(a,b){for(var c,d,e=null,f=4,g=0;g<a.outSegs.length;g++)c=a.outSegs[g],(d=PNLTRI.Math.mapAngle(a,c.vertTo,b))<f&&(f=d,e=c);return e},splitPolygonChain:function(a,b,c,d){var e,f;e=this.get_out_segment_next_right_of(b,c);
f=this.get_out_segment_next_right_of(c,b);e=e.segOut;var g=f.segOut;f=this.createMonoSegment({vFrom:b,vTo:c,upward:!0,mprev:e.mprev,mnext:g});b=this.createMonoSegment({vFrom:c,vTo:b,upward:!1,mprev:g.mprev,mnext:e});e.mprev.mnext=f;g.mprev.mnext=b;e.mprev=b;g.mprev=f;c=this.monoSubPolyChains.length;d?(this.monoSubPolyChains[a]=f,this.monoSubPolyChains[c]=b):(this.monoSubPolyChains[a]=b,this.monoSubPolyChains[c]=f);return c},unique_monotone_chains_max:function(){for(var a,b,c,d,e,f=[],g=0;g<this.monoSubPolyChains.length;g++){a=
b=this.monoSubPolyChains[g];d=e=a.vFrom;a.marked=!0;a=a.mnext;for(var m=!1;(c=a.vFrom)!=d;){if(a.marked){m=!0;break}else a.marked=!0;1==PNLTRI.Math.compare_pts_yx(c,e)&&(e=c,b=a);a=a.mnext}m||f.push(b)}return f},normalize_monotone_chains:function(){this.monoSubPolyChains=this.unique_monotone_chains_max();return this.monoSubPolyChains.length},clearTriangles:function(){this.triangles=[]},addTriangle:function(a,b,c){this.triangles.push([a.id,b.id,c.id])}};PNLTRI.EarClipTriangulator=function(a){this.polyData=a};
PNLTRI.EarClipTriangulator.prototype={constructor:PNLTRI.EarClipTriangulator,triangulate_polygon_no_holes:function(){var a=this.polyData,b=a.getFirstSegment(),c=b;if(a.isClockWise(b)){do c.mprev=c.snext,c=c.mnext=c.sprev;while(c!=b);a.set_PolyLeft_wrong(0)}else{do c.mprev=c.sprev,c=c.mnext=c.snext;while(c!=b)}for(b=a=b;a.mnext!=a.mprev;){a:{var c=a.mprev.vFrom.x,d=a.mprev.vFrom.y,e=a.vFrom.x,f=a.vFrom.y,g=a.mnext.vFrom.x,m=a.mnext.vFrom.y,n=g-e,p=m-f,q=c-g,t=d-m,h=e-c,l=f-d;if(PNLTRI.Math.EPSILON_P>
h*p-n*l)c=!1;else{for(var k=a.mprev.mprev,s=a.mnext;s!=k;){var s=s.mnext,r=s.vFrom.x,u=s.vFrom.y,v=r-c,w=u-d;if(0!=v||0!=w){var x=r-e,y=u-f;if(0!=x||0!=y)if(r-=g,u-=m,(0!=r||0!=u)&&n*y-p*x>=PNLTRI.Math.EPSILON_N&&h*w-l*v>=PNLTRI.Math.EPSILON_N&&q*u-t*r>=PNLTRI.Math.EPSILON_N){c=!1;break a}}}c=!0}}if(c)this.polyData.addTriangle(a.mprev.vFrom,a.vFrom,a.mnext.vFrom),a.mprev.mnext=a.mnext,a.mnext.mprev=a.mprev,b=a=a.mnext;else if(a=a.mnext,a==b)return!1}return!0}};PNLTRI.Trapezoid=function(a,b,c,d){this.vHigh=a?a:{x:Number.POSITIVE_INFINITY,y:Number.POSITIVE_INFINITY};this.vLow=b?b:{x:Number.NEGATIVE_INFINITY,y:Number.NEGATIVE_INFINITY};this.lseg=c;this.rseg=d;this.depth=-1;this.monoDone=!1};
PNLTRI.Trapezoid.prototype={constructor:PNLTRI.Trapezoid,clone:function(){var a=new PNLTRI.Trapezoid(this.vHigh,this.vLow,this.lseg,this.rseg);a.uL=this.uL;a.uR=this.uR;a.dL=this.dL;a.dR=this.dR;a.sink=this.sink;return a},splitOffLower:function(a){var b=this.clone();this.vLow=b.vHigh=a;this.dL=b;b.uL=this;this.dR=b.uR=null;b.dL&&(b.dL.uL=b);b.dR&&(b.dR.uR=b);return b}};PNLTRI.QsNode=function(a){this.trap=a;a.sink=this};PNLTRI.QsNode.prototype={constructor:PNLTRI.QsNode};
PNLTRI.QueryStructure=function(a){var b=new PNLTRI.Trapezoid(null,null,null,null);this.trapArray=[];this.appendTrapEntry(b);this.root=new PNLTRI.QsNode(b);if(a)for(a=a.getSegments(),b=0;b<a.length;b++)a[b].rootFrom=a[b].rootTo=this.root,a[b].is_inserted=!1};
PNLTRI.QueryStructure.prototype={constructor:PNLTRI.QueryStructure,getRoot:function(){return this.root},appendTrapEntry:function(a){a.trapID=this.trapArray.length;this.trapArray.push(a)},cloneTrap:function(a){a=a.clone();this.appendTrapEntry(a);return a},splitNodeAtPoint:function(a,b,c){var d=a.trap;if(d.vHigh==b||d.vLow==b)return a;var e=d.splitOffLower(b);this.appendTrapEntry(e);a.yval=b;a.trap=null;a.right=new PNLTRI.QsNode(d);a.left=new PNLTRI.QsNode(e);return c?d.sink:e.sink},fpEqual:function(a,
b){return Math.abs(a-b)<PNLTRI.Math.EPSILON_P},is_left_of:function(a,b,c){c=a.vFrom.x-b.x;var d=a.vTo.x-b.x;if(Math.abs(a.vTo.y-b.y)<PNLTRI.Math.EPSILON_P)a=d,b=c;else if(Math.abs(a.vFrom.y-b.y)<PNLTRI.Math.EPSILON_P)a=c,b=d;else return a.upward?PNLTRI.Math.ptsCrossProd(a.vFrom,a.vTo,b):PNLTRI.Math.ptsCrossProd(a.vTo,a.vFrom,b);return Math.abs(a)<PNLTRI.Math.EPSILON_P?Math.abs(b)<PNLTRI.Math.EPSILON_P?0:b:a},ptNode:function(a,b,c){for(var d;c;)if(c.yval)d=a==c.yval?b:a,d=PNLTRI.Math.compare_pts_yx(d,
c.yval),c=-1==d?c.left:c.right;else if(c.seg)a==c.seg.vFrom||a==c.seg.vTo?this.fpEqual(a.y,b.y)?c=b.x<a.x?c.left:c.right:(d=this.is_left_of(c.seg,b,!1),c=0<d?c.left:0>d?c.right:a==c.seg.vFrom?c.right:c.left):(d=a,d=this.is_left_of(c.seg,d,!0),c=0<d?c.left:c.right);else return c.trap||console.log("ptNode: unknown type",c),c},add_segment:function(a){function b(){var a=h.uL||h.uR;a.dL&&a.dR?h==a.dL?(k.uL=null,a.dL=l):(l.uR=null,a.dR=k):(k.uL=null,k.uR=a,a.dR=k)}function c(a){h.vLow==t.vLow?(q?h.dL?(a.uL=
l,l.dL=a,k.dR=null):(a.uR=k,l.dL=null,k.dR=a):(a.uL=l,a.uR=k,l.dL=k.dR=a),l.dR=k.dL=null):(a.uL&&a.uR&&(a.uL==h?(a.usave=a.uR,a.uleft=!0):(a.usave=a.uL,a.uleft=!1)),a.uL=l,a.uR=k,l.dR=k.dL=a,l.dL=k.dR=null)}function d(){var b;h.vLow==t.vLow&&q?(h.dL.uL=l,h.dR.uR=k,l.dL=h.dL,k.dR=h.dR,b=l.dR=k.dL=null):(h.dL.uL=l,h.dR.uR=k,0<e.is_left_of(a,h.vLow,!0)?(b=h.dR,h.dR.uL=l,l.dL=h.dL,k.dR=null):(b=h.dL,h.dL.uR=k,k.dR=h.dR,l.dL=null),l.dR=k.dL=b);return b}var e=this,f,g,m,n,p,q;a.upward?(n=a.vFrom,f=a.vTo,
p=a.rootFrom,g=a.rootTo,q=a.sprev.is_inserted,m=a.snext.is_inserted):(n=a.vTo,f=a.vFrom,p=a.rootTo,g=a.rootFrom,q=a.snext.is_inserted,m=a.sprev.is_inserted);g=this.ptNode(f,n,g);m||(g=this.splitNodeAtPoint(g,f,!1));m=g.trap;if(m.uL||m.uR){g=this.ptNode(n,f,p);q||(g=this.splitNodeAtPoint(g,n,!0));var t=g.trap,h=m,l,k,s,r;for(f=this.trapArray.length+2;h;){if(0>--f){console.log("ERR add_segment: infinite loop",h,a,this);return}if(!h.dL&&!h.dR){console.log("ERR add_segment: missing successors",h,a,this);
return}n=h.sink;n.seg=a;n.trap=null;r&&r.rseg==h.rseg?(l=h,k=r,k.vLow=h.vLow,n.left=new PNLTRI.QsNode(l),n.right=r.sink):(s&&s.lseg==h.lseg?(k=h,l=s,l.vLow=h.vLow,n.left=s.sink):(l=h,k=this.cloneTrap(h),n.left=new PNLTRI.QsNode(l)),n.right=new PNLTRI.QsNode(k));h.uL&&h.uR?h.usave?(h.uleft?(k.uL=h.uR,k.uR=h.usave,k.uL.dL=k,k.uR.dR=k):(l.uR=h.uL,l.uL=h.usave,l.uL.dL=l,l.uR.dR=l),l.usave=k.usave=null):h.vHigh==m.vHigh?(k.uR.dR=k,l.uR=k.uL=null):k==h?(k.uL=k.uR,k.uR=null,k.uL.dL=k):(l.uR=l.uL,l.uL=null):
b();h.dL&&h.dR?n=d():(n=h.dL?h.dL:h.dR,c(n));l.rseg&&(l.rseg.trLeft=k);k.lseg&&(k.lseg.trRight=l);l.rseg=k.lseg=a;a.trLeft=l;a.trRight=k;h.vLow!=t.vLow?(s=l,r=k,h=n):h=null}a.is_inserted=!0}else console.log("ERR add_segment: missing trFirst.uX: ",m)},assignDepths:function(a){var b=[this.trapArray[0]],c=[],d,e,f=0;do{for(var g=1==f%2;d=b.pop();)-1==d.depth&&(d.depth=f,d.uL&&b.push(d.uL),d.uR&&b.push(d.uR),d.dL&&b.push(d.dL),d.dR&&b.push(d.dR),(e=d.lseg)&&-1==e.trLeft.depth&&c.push(e.trLeft),e=d.rseg)&&
(-1==e.trRight.depth&&c.push(e.trRight),e.upward!=g&&a.set_PolyLeft_wrong(e.chainId));b=c;c=[];f++}while(0<b.length)},find_first_inside:function(){for(var a,b=0,c=this.trapArray.length;b<c;b++)if(a=this.trapArray[b],1==a.depth%2&&!a.monoDone&&(!a.uL&&!a.uR||!a.dL&&!a.dR)&&a.lseg)return a;return null}};PNLTRI.Trapezoider=function(a){this.polyData=a;this.queryStructure=new PNLTRI.QueryStructure(this.polyData)};
PNLTRI.Trapezoider.prototype={constructor:PNLTRI.Trapezoider,find_first_inside:function(){return this.queryStructure.find_first_inside()},optimise_randomlist:function(a){var b=0,c=this.polyData.nbPolyChains();if(1!=c)for(var d=Array(c),e=a.concat(),f=0;f<e.length;f++){var g=e[f].chainId;d[g]?a[c++]=e[f]:(a[b++]=e[f],d[g]=!0)}},trapezoide_polygon:function(){var a=this.polyData.getSegments().concat();PNLTRI.Math.array_shuffle(a);this.optimise_randomlist(a);for(var b=a.length,c=this.queryStructure,d=
0,e=b;d<b;){for(var e=Math.log(e)/Math.LN2,f=1<e?Math.floor(b/e):b;d<f;d++)c.add_segment(a[d]);for(f=d;f<b;f++){var g=a[f];g.rootFrom=this.queryStructure.ptNode(g.vFrom,g.vTo,g.rootFrom);g.rootTo=this.queryStructure.ptNode(g.vTo,g.vFrom,g.rootTo)}}c.assignDepths(this.polyData);for(f=0;f<b;f++)a[f].trLeft=a[f].trRight=null}};PNLTRI.MonoSplitter=function(a){this.polyData=a;this.startTrap=this.trapezoider=null};
PNLTRI.MonoSplitter.prototype={constructor:PNLTRI.MonoSplitter,monotonate_trapezoids:function(){this.trapezoider=new PNLTRI.Trapezoider(this.polyData);this.trapezoider.trapezoide_polygon();this.startTrap=this.trapezoider.find_first_inside();this.polyData.initMonoChains();for(var a=this.startTrap;a;)this.alyTrap(this.polyData.newMonoChain(a.lseg),a,null,null,null),a=this.trapezoider.find_first_inside();return this.polyData.normalize_monotone_chains()},doSplit:function(a,b,c,d){return this.polyData.splitPolygonChain(a,
b,c,d)},alyTrap:function(a,b,c,d,e){function f(){var a;return(a=g.pop())?(m=a[0],n=a[1],p=a[2],q=a[3],!0):!1}var g=[],m,n,p,q,t;null==c&&(d=!0,b.uL?c=!0:b.dL?c=!1:(d=!1,c=b.uR?!0:!1));for(b&&g.push([b,c,d,a]);f();)if(!m.monoDone){m.monoDone=!0;if(!m.lseg||!m.rseg)return console.log("ERR alyTrap: lseg/rseg missing",m),g;n?p?(a=m.uL,b=m.uR,c=m.dL,d=m.dR):(a=m.uR,b=m.uL,c=m.dR,d=m.dL):p?(a=m.dL,b=m.dR,c=m.uL,d=m.uR):(a=m.dR,b=m.dL,c=m.uR,d=m.uL);if(b||d)t=this.doSplit(q,m.vLow,m.vHigh,p);d&&g.push([d,
n,!p,t]);b&&g.push([b,!n,!p,t]);c&&g.push([c,n,p,q]);c||d||a&&g.push([a,!n,p,q]);if(e)return g}return[]}};PNLTRI.MonoTriangulator=function(a){this.polyData=a};
PNLTRI.MonoTriangulator.prototype={constructor:PNLTRI.MonoTriangulator,triangulate_all_polygons:function(){var a=this.polyData.getMonoSubPolys();this.polyData.clearTriangles();for(var b=0;b<a.length;b++){var c=a[b],d=c.mprev,e=c.mnext;e.mnext==d?this.polyData.addTriangle(c.vFrom,e.vFrom,d.vFrom):this.triangulate_monotone_polygon(c)}},triangulate_monotone_polygon:function(a){var b=a.mnext;a=a.vFrom;var c=[b.vFrom],d=0,b=b.mnext,e=b.vFrom;if(e!=a){for(;e!=a||1<d;)if(0<d)if(0<PNLTRI.Math.ptsCrossProd(e,
c[d-1],c[d]))this.polyData.addTriangle(c[d-1],c[d],e),d--;else if(c[++d]=e,e==a)for(console.log("ERR uni-y-monotone: only concave angles left",c);1<d;)d--,this.polyData.addTriangle(c[d-1],c[d],c[d+1]);else b=b.mnext,e=b.vFrom;else c[++d]=e,b=b.mnext,e=b.vFrom;this.polyData.addTriangle(c[d-1],c[d],e)}}};PNLTRI.Triangulator=function(){this.lastPolyData=null};
PNLTRI.Triangulator.prototype={constructor:PNLTRI.Triangulator,clear_lastData:function(){this.lastPolyData=null},get_PolyLeftArr:function(){return this.lastPolyData?this.lastPolyData.get_PolyLeftArr():null},triangulate_polygon:function(a,b){this.clear_lastData();if(!a||0==a.length)return[];var c=new PNLTRI.PolygonData(a),d;d=b?!1:1==c.nbPolyChains();d&&(d=new PNLTRI.EarClipTriangulator(c),d=d.triangulate_polygon_no_holes());if(!d){(new PNLTRI.MonoSplitter(c)).monotonate_trapezoids();d=new PNLTRI.MonoTriangulator(c);
d.triangulate_all_polygons();d=c.getSegments();for(var e=0;e<d.length;e++)d[e].vFrom.outSegs=null}this.lastPolyData=c;return c.getTriangles()}};
