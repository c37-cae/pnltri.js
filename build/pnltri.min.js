// pnltri.js / raw.github.com/jahting/pnltri.js/master/LICENSE
'use strict';var q={ea:"1.4"};q.c={random:Math.random,fa:function(b){for(var c=b.length-1;0<c;c--){var g=Math.floor(q.c.random()*(c+1)),d=b[c];b[c]=b[g];b[g]=d}return b},I:function(b,c){var g=b.y-c.y;if(g<q.c.G)return-1;if(g>q.c.m)return 1;g=b.x-c.x;return g<q.c.G?-1:g>q.c.m?1:0},Q:function(b,c,g){return(c.x-b.x)*(g.y-b.y)-(c.y-b.y)*(g.x-b.x)},ca:function(b){return Math.sqrt(b.x*b.x+b.y*b.y)},ha:function(b,c){return b.x*c.x+b.y*c.y},ga:function(b,c){return b.x*c.y-c.x*b.y},ia:function(b,c,g){c={x:c.x-b.x,y:c.y-b.y};b={x:g.x-b.x,
y:g.y-b.y};g=q.c.ha(c,b)/q.c.ca(c)/q.c.ca(b);return 0<=q.c.ga(c,b)?1-g:3+g}};q.c.m=Math.pow(2,-43);q.c.G=-q.c.m;function u(b){this.da=[];this.s=[];this.O=0;this.H=[];this.q=[];this.X=[];if(b)for(var c=0,g=b.length;c<g;c++){var d=w(this,b[c]);if(3>d.length)console.log("Polygon has < 3 vertices!",d);else{for(var a=void 0,e=void 0,h=void 0,f=0;f<d.length-1;f++)a=x(this,d[f],d[f+1]),h?(a.n=h,h.l=a):e=a,h=a,this.s.push(a);a=x(this,d[d.length-1],d[0]);a.n=h;h.l=a;this.s.push(a);e.n=a;a.l=e;this.H[this.O++]=!0}}}u.prototype={U:function(){return this.H.concat()}};function B(b,c,g,d){b.X.push([c.id,g.id,d.id])}
function D(b,c,g,d,a){var e=E(g,d).R,h=E(d,g).R,f=F(b,{a:g,i:d,p:!0,j:e.j,h:h});g=F(b,{a:d,i:g,p:!1,j:h.j,h:e});e.j.h=f;h.j.h=g;e.j=g;h.j=f;e=b.q.length;a?(b.q[c]=f,b.q[e]=g):(b.q[c]=g,b.q[e]=f);return e}function E(b,c){for(var g,d,a=null,e=4,h=0;h<b.A.length;h++)g=b.A[h],d=q.c.ia(b,g.F,c),4==b.id&&19==b.y&&20==c.id&&(5==g.F.id?d=3.9:16==g.F.id&&(d=3.8)),d<e?(e=d,a=g):d!=e||0==b.id&&18==c.id&&11==g.F.id||(a=g);return a}function F(b,c){b.s.push(c);c.a.A.push({R:c,F:c.i});return c}
function w(b,c){function g(a,b){return Math.abs(a.x-b.x)<q.c.m&&Math.abs(a.y-b.y)<q.c.m}function d(a,b,c){if(Math.abs(q.c.Q(b,a,c))>q.c.m)return!1;var d;Math.abs(a.y-b.y)<q.c.m?(d=b.x,a.x<c.x?(b=a.x,a=c.x):(b=c.x,a=a.x)):(d=b.y,a.y<c.y?(b=a.y,a=c.y):(b=c.y,a=a.y));return b-d<q.c.m&&d-a<q.c.m}for(var a=[],e,h,f,l=0;l<c.length;l++)e=G(b,c[l].x,c[l].y),h=!0,f=a.length-1,0<=f&&(g(e,a[f])?h=!1:0<f&&d(a[f-1],a[f],e)&&a.pop()),h&&a.push(e);f=a.length-1;0<f&&g(a[f],a[0])&&(a.pop(),f--);1<f&&(d(a[f-1],a[f],
a[0])&&(a.pop(),f--),1<f&&d(a[f],a[0],a[1])&&a.shift());return a}function x(b,c,g){return{T:b.O,a:c,i:g,p:1==q.c.I(g,c),n:null,l:null,J:null,K:null,w:!1,L:null,M:null,j:null,h:null,V:!1}}function G(b,c,g){c={id:b.da.length,x:c,y:g,A:[]};b.da.push(c);return c};function H(b){this.k=b}H.prototype={};function I(b,c,g,d){this.v=b?b:{x:Number.POSITIVE_INFINITY,y:Number.POSITIVE_INFINITY};this.o=c?c:{x:Number.NEGATIVE_INFINITY,y:Number.NEGATIVE_INFINITY};this.r=g;this.t=d;this.depth=-1;this.W=!1}I.prototype={};function J(b){var c=new I(b.v,b.o,b.r,b.t);c.e=b.e;c.f=b.f;c.b=b.b;c.d=b.d;c.u=b.u;return c}function K(b){this.B=b;b.u=this}K.prototype={};
function L(b){var c=new I(null,null,null,null);this.C=[];N(this,c);this.root=new K(c);if(b)for(b=b.s,c=0;c<b.length;c++)b[c].J=b[c].K=this.root,b[c].w=!1}L.prototype={N:function(){for(var b,c=0,g=this.C.length;c<g;c++)if(b=this.C[c],1==b.depth%2&&!b.W&&(!b.e&&!b.f||!b.b&&!b.d)&&b.r)return b;return null}};
function O(b,c){function g(){var a=m.e||m.f;a.b&&a.d?m==a.b?(p.e=null,a.b=r):(r.f=null,a.d=p):(p.e=null,p.f=a,a.d=p)}function d(a){m.o==t.o?(f?m.b?(a.e=r,r.b=a,p.d=null):(a.f=p,r.b=null,p.d=a):(a.e=r,a.f=p,r.b=p.d=a),r.d=p.b=null):(a.e&&a.f&&(a.e==m?(a.D=a.f,a.ba=!0):(a.D=a.e,a.ba=!1)),a.e=r,a.f=p,r.d=p.b=a,r.b=p.d=null)}function a(){var a;if(m.o==t.o&&f)m.b.e=r,m.d.f=p,r.b=m.b,p.d=m.d,a=r.d=p.b=null;else{m.b.e=r;m.d.f=p;var b=P(c,m.o);if(0<b)a=!0;else if(0>b)a=!1;else{a=m.b.t;var d=a.p,b=d?a.a:a.i,
b=P(c,b);0<b?a=!0:0>b?a=!1:(a=d?a.l:a.n,b=d?a.i:a.a,b=P(c,b),a=0<b?!0:!1)}a?(a=m.d,m.d.e=r,r.b=m.b,p.d=null):(a=m.b,m.b.f=p,p.d=m.d,r.b=null);r.d=p.b=a}return a}Q(c);var e,h,f,l,k,n;c.p?(e=c.a,l=c.i,h=c.J,k=c.K,f=c.n.w,n=c.l.w):(e=c.i,l=c.a,h=c.K,k=c.J,f=c.l.w,n=c.n.w);n||(n=R(b,k,l,!1),k==h&&(h=n),k=n);k=k.B;if(k.e||k.f)if(k.v!=l)console.log("ERR add_segment: trFirstHigh != segHigh: ",k);else{f||(h=R(b,h,e,!0));var t=h.B,m=k,r,p,y,v;for(e=b.C.length+2;m;){if(0>--e){console.log("ERR add_segment: infinite loop",
m,c,b);return}if(!m.b&&!m.d){console.log("ERR add_segment: missing successors",m,c,b);return}h=m.u;h.g=c;h.B=null;v&&v.t==m.t?(r=m,p=v,p.o=m.o,h.left=new K(r),h.right=v.u):(y&&y.r==m.r?(p=m,r=y,r.o=m.o,h.left=y.u):(r=m,p=ba(b,m),h.left=new K(r)),h.right=new K(p));m.e&&m.f?m.D?(m.ba?(p.e=m.f,p.f=m.D,p.e.b=p,p.f.d=p):(r.f=m.e,r.e=m.D,r.e.b=r,r.f.d=r),r.D=p.D=null):m.v==k.v?(p.f.d=p,r.f=p.e=null):p==m?(p.e=p.f,p.f=null,p.e.b=p):(r.f=r.e,r.e=null):g();m.b&&m.d?h=a():(h=m.b?m.b:m.d,d(h));r.t&&(r.t.L=p);
p.r&&(p.r.M=r);r.t=p.r=c;c.L=r;c.M=p;m.o!=t.o?(y=r,v=p,m=h):m=null}c.w=!0}else console.log("ERR add_segment: missing trFirst.uX: ",k)}
function S(b,c){if(c)var g=b.a,d=b.i,a=b.J;else g=b.i,d=b.a,a=b.K;for(var e;a;)if(a.Y)e=g==a.Y?d:g,e=q.c.I(e,a.Y),a=-1==e?a.left:a.right;else if(a.g)if(g==a.g.a||g==a.g.i)if(Math.abs(g.y-d.y)<q.c.m)a=Math.abs(a.g.a.y-a.g.i.y)<q.c.m?g==a.g.a?(e=d.x>g.x?d.x<a.g.i.x:d.x>=a.g.i.x)?b.n.p?a.right:a.left:a.g.l.p?a.right:a.left:(e=d.x>g.x?d.x<a.g.a.x:d.x>=a.g.a.x)?b.l.p?a.left:a.right:a.g.n.p?a.left:a.right:d.x<g.x?a.left:a.right;else if(e=P(a.g,d),0<e)a=a.left;else if(0>e)a=a.right;else if(e=g==a.g.a?(e=
a.g.p?d.y<a.g.i.y:d.y>=a.g.i.y)?P(a.g,b.n.a):-P(a.g,a.g.l.i):(e=a.g.p?d.y>=a.g.a.y:d.y<a.g.a.y)?P(a.g,b.l.i):-P(a.g,a.g.n.a),0<e)a=a.left;else if(0>e)a=a.right;else break;else if(e=P(a.g,g),0<e)a=a.left;else if(0>e)a=a.right;else if(e=P(a.g,d),0<e)a=a.left;else if(0>e)a=a.right;else if(e=P(a.g,c?b.n.a:b.l.i),0<e)a=a.left;else if(0>e)a=a.right;else break;else{a.B||console.log("ptNode: unknown type",a);c?b.J=a:b.K=a;break}}function Q(b){S(b,!0);S(b,!1)}
function P(b,c){var g;g=b.a.x-c.x;var d=b.i.x-c.x,a=Math.abs(b.a.y-c.y)<q.c.m;if(Math.abs(b.i.y-c.y)<q.c.m){if(a)return 0;g=d}else if(!a)return b.p?q.c.Q(b.a,b.i,c):q.c.Q(b.i,b.a,c);return Math.abs(g)<q.c.m?0:g}function R(b,c,g,d){var a=c.B;if(a.v==g||a.o==g)return c;var e=J(a);a.o=e.v=g;a.b=e;e.e=a;a.d=e.f=null;e.b&&(e.b.e=e);e.d&&(e.d.f=e);N(b,e);c.Y=g;c.B=null;c.right=new K(a);c.left=new K(e);return d?a.u:e.u}function ba(b,c){var g=J(c);N(b,g);return g}
function N(b,c){c.ka=b.C.length;b.C.push(c)}function X(b){this.k=b;this.$=new L(this.k)}X.prototype={N:function(){return this.$.N()}};function Y(b){this.k=b;this.aa=this.S=null}Y.prototype={};
function ca(b,c,g){var d=null,a=null;function e(){var a;return(a=h.pop())?(f=a[0],l=a[1],k=a[2],n=a[3],!0):!1}var h=[],f,l,k,n,t;null==d&&(a=!0,g.e?d=!0:g.b?d=!1:(a=!1,d=g.f?!0:!1));for(g&&h.push([g,d,a,c]);e();)if(!f.W){f.W=!0;if(!f.r||!f.t){console.log("ERR alyTrap: lseg/rseg missing",f);break}l?k?(c=f.e,g=f.f,d=f.b,a=f.d):(c=f.f,g=f.e,d=f.d,a=f.b):k?(c=f.b,g=f.d,d=f.e,a=f.f):(c=f.d,g=f.b,d=f.f,a=f.e);if(g||a)t=D(b.k,n,f.o,f.v,k);a&&h.push([a,l,!k,t]);g&&h.push([g,!l,!k,t]);d&&h.push([d,l,k,n]);
d||a||c&&h.push([c,!l,k,n])}};function Z(b){this.k=b}Z.prototype={};function $(){this.P=null}
$.prototype={Z:function(){this.P=null},U:function(){return this.P?this.P.U():null},ja:function(b,c){this.Z();if(!b||0==b.length)return[];var g=new u(b),d=c?!1:1==g.O;if(d){d=new H(g);a:{var a=d.k,e=a.s[0],h=e,f=e,l=0;do l+=(f.a.x-f.i.x)*(f.a.y+f.i.y),f=f.l;while(f!=e);if(0>l){do h.j=h.l,h=h.h=h.n;while(h!=e);a.H[0]=!1}else{do h.j=h.n,h=h.h=h.l;while(h!=e)}for(e=a=e;a.h!=a.j;){b:{var h=a.j.a.x,f=a.j.a.y,l=a.a.x,k=a.a.y,n=a.h.a.x,t=a.h.a.y,m=n-l,r=t-k,p=h-n,y=f-t,v=l-h,M=k-f;if(q.c.m>v*r-m*M)h=!1;else{for(var aa=
a.j.j,C=a.h;C!=aa;){var C=C.h,z=C.a.x,A=C.a.y,T=z-h,U=A-f;if(0!=T||0!=U){var V=z-l,W=A-k;if(0!=V||0!=W)if(z-=n,A-=t,(0!=z||0!=A)&&m*W-r*V>=q.c.G&&v*U-M*T>=q.c.G&&p*A-y*z>=q.c.G){h=!1;break b}}}h=!0}}if(h)B(d.k,a.j.a,a.a,a.h.a),a.j.h=a.h,a.h.j=a.j,e=a=a.h;else if(a=a.h,a==e){d=!1;break a}}d=!0}}if(!d){d=new Y(g);d.S=new X(d.k);e=d.S;a=e.k.s.concat();q.c.fa(a);h=0;f=e.k.O;if(1!=f)for(l=Array(f),k=a.concat(),n=0;n<k.length;n++)t=k[n].T,l[t]?a[f++]=k[n]:(a[h++]=k[n],l[t]=!0);h=a.length;f=e.$;l=0;for(k=
h;l<h;){k=Math.log(k)/Math.LN2;for(n=1<k?Math.floor(h/k):h;l<n;l++)O(f,a[l]);for(n=l;n<h;n++)Q(a[n])}var e=e.k,f=[f.C[0]],l=[],s,n=0;do{for(t=1==n%2;k=f.pop();)-1==k.depth&&(k.depth=n,k.e&&f.push(k.e),k.f&&f.push(k.f),k.b&&f.push(k.b),k.d&&f.push(k.d),(s=k.r)&&-1==s.L.depth&&l.push(s.L),s=k.t)&&(-1==s.M.depth&&l.push(s.M),s.p!=t&&(e.H[s.T]=!1));f=l;l=[];n++}while(0<f.length);for(n=0;n<h;n++)a[n].L=a[n].M=null;d.aa=d.S.N();s=d.k;for(e=0;e<s.s.length;e++)a=s.s[e],s.H[a.T]?(a.j=a.n,a.h=a.l,a.a.A.push({R:a,
F:a.i})):(a=a.l,a.j=a.l,a.h=a.n,a.a.A.push({R:a,F:s.s[e].a}));for(s=d.aa;s;)a=ca,e=d,h=d.k,f=h.q.length,h.q[f]=s.r,a(e,f,s),s=d.S.N();s=d.k;l=[];for(k=0;k<s.q.length;k++){d=a=s.q[k];h=f=d.a;d.V=!0;d=d.h;for(n=!1;e=d.a;){if(d.V){e!=h&&(n=!0);break}else d.V=!0;1==q.c.I(e,f)&&(f=e,a=d);d=d.h}n||l.push(a)}s.q=l;s=d=new Z(g);d=s.k.q;s.k.X=[];for(a=0;a<d.length;a++)if(f=d[a],e=f.j,h=f.h,h.h==e)B(s.k,f.a,h.a,e.a);else if(e=s,h=f.h,f=f.a,l=[h.a],k=0,h=h.h,n=h.a,n!=f){for(;n!=f||1<k;)if(0<k)if(t=q.c.Q(l[k],
n,l[k-1]),Math.abs(t)<=q.c.m&&(n==f||q.c.I(l[k],n)==q.c.I(l[k],l[k-1]))&&(t=1),0<t)B(e.k,l[k-1],l[k],n),k--;else if(l[++k]=n,n==f)for(console.log("ERR uni-y-monotone: only concave angles left",l);1<k;)k--,B(e.k,l[k-1],l[k],l[k+1]);else h=h.h,n=h.a;else l[++k]=n,h=h.h,n=h.a;B(e.k,l[k-1],l[k],n)}s=g.s;for(d=0;d<s.length;d++)s[d].a.A=null}this.P=g;return g.X.concat()}};window.PNLTRI=q;q.REVISION=q.ea;q.Math=q.c;q.Triangulator=$;$.prototype.clear_lastData=$.prototype.Z;$.prototype.get_PolyLeftArr=$.prototype.U;$.prototype.triangulate_polygon=$.prototype.ja;
