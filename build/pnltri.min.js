// pnltri.js / raw.github.com/jahting/pnltri.js/master/LICENSE
'use strict';var PNLTRI={REVISION:"0.8"};PNLTRI.Math={log2:function(a){return Math.log(a)/Math.LN2},random:Math.random,array_shuffle:function(a){for(var b=a.length-1;0<b;b--){var c=Math.floor(PNLTRI.Math.random()*(b+1)),d=a[b];a[b]=a[c];a[c]=d}return a},ptsCrossProd:function(a,b,c){return(b.x-a.x)*(c.y-a.y)-(b.y-a.y)*(c.x-a.x)}};PNLTRI.Math.EPSILON_P=Math.pow(2,-43);PNLTRI.Math.EPSILON_N=-PNLTRI.Math.EPSILON_P;PNLTRI.PolygonData=function(a){this.vertices=[];this.segments=[];this.monoSubPolyChains=[];this.triangles=[];if(a){this.addPolygonChain(a[0],!1);for(var b=1,c=a.length;b<c;b++)this.addPolygonChain(a[b],!0)}};
PNLTRI.PolygonData.prototype={constructor:PNLTRI.PolygonData,getSegments:function(){return this.segments},getMonoSubPolys:function(){return this.monoSubPolyChains},getTriangles:function(){return this.triangles.concat()},compare_pts_yx:function(a,b){var c=a.y-b.y;if(c>PNLTRI.Math.EPSILON_P)return 1;if(c<PNLTRI.Math.EPSILON_N)return-1;c=a.x-b.x;return c>PNLTRI.Math.EPSILON_P?1:c<PNLTRI.Math.EPSILON_N?-1:0},polygon_area:function(a){for(var b=a.length,c=0,d=b-1,e=0;e<b;d=e++)c+=a[d].x*a[e].y-a[e].x*a[d].y;
return 0.5*c},appendVertexEntry:function(a){a=a?a:{pt:null,outSegs:[]};a.id=this.vertices.length;this.vertices.push(a);return a},createSegmentEntry:function(a,b){return{vFrom:a,vTo:b,upward:1==this.compare_pts_yx(b.pt,a.pt),sprev:null,snext:null}},appendSegmentEntry:function(a){this.segments.push(a);0==this.monoSubPolyChains.length&&(this.monoSubPolyChains=[this.segments[0]]);return a},addVertexChain:function(a,b){function c(a,b){return Math.abs(a.pt.x-b.pt.x)<PNLTRI.Math.EPSILON_P&&Math.abs(a.pt.y-
b.pt.y)<PNLTRI.Math.EPSILON_P}var d=!1;null!=b&&(d=0>this.polygon_area(a),d=b!=d);for(var e=[],k,l,h,g=0;g<a.length;g++)k=this.appendVertexEntry({pt:{x:a[g].x,y:a[g].y}}),l=!0,h=e.length-1,0<=h&&c(k,e[h])&&(l=!1),l&&e.push(k);1<e.length&&c(e[e.length-1],e[0])&&e.pop();d&&(e=e.reverse());return e},addPolygonChain:function(a,b){var c=this.addVertexChain(a,b);if(3>c.length)return console.log("Polygon has < 3 vertices!",c),0;for(var d=this.segments.length,e,k,l,h=0;h<c.length-1;h++)e=this.createSegmentEntry(c[h],
c[h+1]),l?(e.sprev=l,l.snext=e):k=e,l=e,this.appendSegmentEntry(e);e=this.createSegmentEntry(c[c.length-1],c[0]);e.sprev=l;l.snext=e;this.appendSegmentEntry(e);k.sprev=e;e.snext=k;return this.segments.length-d},initMonoChains:function(){for(var a=0;a<this.segments.length;a++)this.segments[a].marked=!1,this.segments[a].mprev=this.segments[a].sprev,this.segments[a].mnext=this.segments[a].snext,this.segments[a].vFrom.outSegs=[{segOut:this.segments[a],vertTo:this.segments[a].vTo}]},appendVertexOutsegEntry:function(a,
b){var c=b?b:{segOut:null,vertTo:null};a.outSegs.push(c);return c},splitPolygonChain:function(a,b,c){function d(a,b){for(var c,d,e=null,h=4,n=0;n<a.outSegs.length;n++){c=a.outSegs[n];var k=a.pt,l=c.vertTo.pt,u=b.pt;d=l.x-k.x;var l=l.y-k.y,v=u.x-k.x,k=u.y-k.y,u=(d*v+l*k)/Math.sqrt(d*d+l*l)/Math.sqrt(v*v+k*k);(d=0<=d*k-v*l?1-u:3+u)<h&&(h=d,e=c)}return e}var e=d(b,c),k=d(c,b),e=e.segOut,k=k.segOut,l=1==this.compare_pts_yx(b.pt,c.pt),h=this.appendSegmentEntry({vFrom:b,vTo:c,upward:!l,mprev:e.mprev,mnext:k}),
l=this.appendSegmentEntry({vFrom:c,vTo:b,upward:l,mprev:k.mprev,mnext:e});e.mprev.mnext=h;k.mprev.mnext=l;e.mprev=l;k.mprev=h;this.appendVertexOutsegEntry(b,{segOut:h,vertTo:c});this.appendVertexOutsegEntry(c,{segOut:l,vertTo:b});this.monoSubPolyChains[a]=k;this.monoSubPolyChains.push(e);return this.monoSubPolyChains.length-1},unique_monotone_chains_max:function(){var a,b,c,d,e,k;for(k=0;k<this.segments.length;k++)this.segments[k].marked=!1;var l=[];for(k=0;k<this.monoSubPolyChains.length;k++){a=
b=this.monoSubPolyChains[k];d=e=a.vFrom.pt;a.marked=!0;a=a.mnext;for(var h=!1;(c=a.vFrom.pt)!=d;){if(a.marked){h=!0;break}else a.marked=!0;1==this.compare_pts_yx(c,e)&&(e=c,b=a);a=a.mnext}h||l.push(b)}return l},normalize_monotone_chains:function(){this.monoSubPolyChains=this.unique_monotone_chains_max();return this.monoSubPolyChains.length},clearTriangles:function(){this.triangles=[]},addTriangle:function(a,b,c){this.triangles.push([a.id,b.id,c.id])}};PNLTRI.TRAP_MIDDLE=0;PNLTRI.TRAP_LEFT=1;PNLTRI.TRAP_RIGHT=2;PNLTRI.TRAP_CUSP=3;PNLTRI.trapCounter=0;PNLTRI.Trapezoid=function(a,b,c,d){this.trapID=PNLTRI.trapCounter++;this.hiPt=a?a:{x:Number.POSITIVE_INFINITY,y:Number.POSITIVE_INFINITY};this.loPt=b?b:{x:Number.NEGATIVE_INFINITY,y:Number.NEGATIVE_INFINITY};this.lseg=c;this.rseg=d;this.depth=-1;this.monoDiag=null};
PNLTRI.Trapezoid.prototype={constructor:PNLTRI.Trapezoid,setAbove:function(a,b){this.u0=a;this.u1=b},setBelow:function(a,b){this.d0=a;this.d1=b},setSink:function(a){this.sink=a},replaceAbove:function(a,b){this.u0==a?this.u0=b:this.u1==a&&(this.u1=b)},splitOffLower:function(a){var b=this.clone();this.loPt=b.hiPt=a;this.d0=b;this.d1=null;b.u0=this;b.u1=null;b.d0&&b.d0.replaceAbove(this,b);b.d1&&b.d1.replaceAbove(this,b);return b},clone:function(){var a=new PNLTRI.Trapezoid(this.hiPt,this.loPt,this.lseg,
this.rseg);a.u0=this.u0;a.u1=this.u1;a.d0=this.d0;a.d1=this.d1;a.sink=this.sink;return a}};PNLTRI.T_Y=1;PNLTRI.T_X=2;PNLTRI.T_SINK=3;PNLTRI.S_LEFT=1;PNLTRI.S_RIGHT=2;PNLTRI.qsCounter=0;PNLTRI.QsNode=function(a,b,c){this.qsNodeID=PNLTRI.qsCounter++;this.nodetype=a;c&&(a==PNLTRI.T_Y?this.yval=c:a==PNLTRI.T_X?this.seg=c:this.trap=c)};
PNLTRI.QsNode.prototype={constructor:PNLTRI.QsNode,newRight:function(a,b){return this.right=new PNLTRI.QsNode(a,this,b)},newLeft:function(a,b){return this.left=new PNLTRI.QsNode(a,this,b)}};
PNLTRI.QueryStructure=function(a){PNLTRI.trapCounter=0;PNLTRI.qsCounter=0;this.root=new PNLTRI.QsNode(PNLTRI.T_SINK,null,null);var b=new PNLTRI.Trapezoid(null,null,null,null);b.setSink(this.root);this.root.trap=b;this.trapezoids=[b];this.segListArray=null;if(a){this.segListArray=a.getSegments();for(b=0;b<this.segListArray.length;b++)this.segListArray[b].rootFrom=this.segListArray[b].rootTo=this.root,this.segListArray[b].is_inserted=!1;this.compare_pts_yx=a.compare_pts_yx}else this.compare_pts_yx=
(new PNLTRI.PolygonData(null)).compare_pts_yx};
PNLTRI.QueryStructure.prototype={constructor:PNLTRI.QueryStructure,getRoot:function(){return this.root},getSegListArray:function(){return this.segListArray},cloneTrap:function(a){a=a.clone();this.trapezoids.push(a);return a},splitNodeAtPoint:function(a,b,c){var d=a.trap;if(d.hiPt==b||d.loPt==b)return a;var e=d.splitOffLower(b);this.trapezoids.push(e);a.nodetype=PNLTRI.T_Y;a.yval=b;a.trap=null;d.sink=a.newRight(PNLTRI.T_SINK,d);e.sink=a.newLeft(PNLTRI.T_SINK,e);return c?d.sink:e.sink},fpEqual:function(a,
b){return Math.abs(a-b)<PNLTRI.Math.EPSILON_P},inside_polygon:function(a){var b=a.rseg;return a.lseg&&a.rseg?!a.u0&&!a.u1||!a.d0&&!a.d1?b.upward:!1:!1},is_left_of:function(a,b,c){c=a.vFrom.pt.x-b.x;var d=a.vTo.pt.x-b.x;if(Math.abs(a.vTo.pt.y-b.y)<PNLTRI.Math.EPSILON_P)a=d,b=c;else if(Math.abs(a.vFrom.pt.y-b.y)<PNLTRI.Math.EPSILON_P)a=c,b=d;else return a.upward?PNLTRI.Math.ptsCrossProd(a.vFrom.pt,a.vTo.pt,b):PNLTRI.Math.ptsCrossProd(a.vTo.pt,a.vFrom.pt,b);return Math.abs(a)<PNLTRI.Math.EPSILON_P?Math.abs(b)<
PNLTRI.Math.EPSILON_P?0:b:a},ptNode:function(a,b,c){var d,e=!0;switch(c.nodetype){case PNLTRI.T_SINK:return c;case PNLTRI.T_Y:d=a;d==c.yval&&(d=b);d=this.compare_pts_yx(d,c.yval);-1==d&&(e=!1);break;case PNLTRI.T_X:if(a==c.seg.vFrom.pt||a==c.seg.vTo.pt){if(this.fpEqual(a.y,b.y)){b.x<a.x&&(e=!1);break}else d=this.is_left_of(c.seg,b,!1),0<d?e=!1:0==d&&(e=a==c.seg.vFrom.pt?!0:!1);break}else d=this.is_left_of(c.seg,a,!0),0<d?e=!1:0==d&&(e=!0);break;default:console.log("ptNode: undef. NodeType: ",c.nodetype)}return e?
this.ptNode(a,b,c.right):this.ptNode(a,b,c.left)},add_segment:function(a){function b(a){f.loPt==r.loPt&&q?f.rseg==p?(a.u0=m,m.setBelow(a,null),n.setBelow(null,null)):(a.u1=n,n.setBelow(a,null),m.setBelow(null,null)):(a.u0&&a.u1&&(a.u0==f?(a.usave=a.u1,a.uside=PNLTRI.S_LEFT):(a.usave=a.u0,a.uside=PNLTRI.S_RIGHT)),a.setAbove(m,n),m.setBelow(a,null),n.setBelow(a,null))}function c(){var b;f.loPt==r.loPt&&q?(f.d0.setAbove(m,null),f.d1.setAbove(n,null),b=f.d1,m.setBelow(f.d0,null),n.setBelow(b,null),b=
null):0<d.is_left_of(a,f.loPt,!0)?(b=f.d1,f.d0.setAbove(m,null),f.d1.setAbove(m,n),m.setBelow(f.d0,f.d1),n.setBelow(f.d1,null)):(b=f.d0,f.d0.setAbove(m,n),f.d1.setAbove(n,null),n.setBelow(f.d0,f.d1),m.setBelow(f.d0,null));return b}var d=this,e,k,l,h,g,p;a.upward?(h=a.vFrom.pt,e=a.vTo.pt,g=a.rootFrom,k=a.rootTo,p=a.sprev,l=a.snext):(h=a.vTo.pt,e=a.vFrom.pt,g=a.rootTo,k=a.rootFrom,p=a.snext,l=a.sprev);var q=!1;k=this.ptNode(e,h,k);l.is_inserted||(k=this.splitNodeAtPoint(k,e,!1));var f=k.trap;k=this.ptNode(h,
e,g);p.is_inserted?q=!0:k=this.splitNodeAtPoint(k,h,!0);var r=k.trap,m,n,s,t;for(e=this.trapezoids.length+2;f;){if(0>--e){console.log("ERR add_segment: infinite loop",f,a,this);return}if(!f.d0&&!f.d1){console.log("ERR add_segment: missing successors",f,a,this);return}l=f.sink;l.nodetype=PNLTRI.T_X;l.seg=a;l.trap=null;h=g=!0;t&&t.rseg==f.rseg?(g=!1,m=f,n=t,n.loPt=f.loPt,l.right=t.sink,m.sink=l.newLeft(PNLTRI.T_SINK,m)):s&&s.lseg==f.lseg?(h=!1,n=f,m=s,m.loPt=f.loPt,l.left=s.sink,n.sink=l.newRight(PNLTRI.T_SINK,
n)):(m=f,n=this.cloneTrap(f),n.sink=l.newRight(PNLTRI.T_SINK,n),m.sink=l.newLeft(PNLTRI.T_SINK,m));f.u0&&f.u1?f.usave?(f.uside==PNLTRI.S_LEFT?(g&&(n.setAbove(f.u1,f.usave),n.u0.d0=n,n.u1.d0=n),h&&(m.u1=null,m.u0.d0=m)):(g&&(n.setAbove(f.u1,null),n.u0.d0=n),h&&(m.setAbove(f.usave,f.u0),m.u0.d0=m,m.u1.d0=m)),m.usave=n.usave=null):(g&&(n.setAbove(f.u1,null),n.u0.d0=n),h&&(m.u1=null)):f.u0.d0&&f.u0.d1?f==f.u0.d1?(g&&(n.u0.d1=n,n.u1=null),h&&m.setAbove(null,null)):(g&&n.setAbove(null,null),h&&(m.u0.d0=
m,m.u1=null)):h&&m.u0.setBelow(m,n);f.d0&&f.d1?l=c():(l=f.d0?f.d0:f.d1,b(l));m.rseg=n.lseg=a;f.loPt!=r.loPt?(s=m,t=n,f=l):f=null}a.is_inserted=!0},find_first_inside:function(){for(var a=0,b=this.trapezoids.length;a<b;a++)if(this.inside_polygon(this.trapezoids[a]))return this.trapezoids[a];return null},update_trapezoids:function(){for(var a,b=0,c=this.trapezoids.length;b<c;b++)a=this.trapezoids[b],a.u0&&a.u1?(a.hiVert=a.u0.rseg.vFrom,a.topLoc=PNLTRI.TRAP_MIDDLE):a.lseg&&a.hiPt==a.lseg.vFrom.pt?(a.hiVert=
a.lseg.vFrom,a.topLoc=a.u0||a.u1?PNLTRI.TRAP_LEFT:PNLTRI.TRAP_CUSP):a.rseg?(a.hiVert=a.rseg.vTo,a.topLoc=PNLTRI.TRAP_RIGHT):a.lseg&&a.hiPt==a.lseg.vTo.pt&&(a.hiVert=a.lseg.vTo,a.topLoc=PNLTRI.TRAP_LEFT),a.d0&&a.d1?(a.loVert=a.d1.lseg.vFrom,a.botLoc=PNLTRI.TRAP_MIDDLE):a.lseg&&a.loPt==a.lseg.vTo.pt?(a.loVert=a.lseg.vTo,a.botLoc=a.d0||a.d1?PNLTRI.TRAP_LEFT:PNLTRI.TRAP_CUSP):a.rseg?(a.loVert=a.rseg.vFrom,a.botLoc=PNLTRI.TRAP_RIGHT):a.lseg&&a.loPt==a.lseg.vFrom.pt&&(a.loVert=a.lseg.vFrom,a.botLoc=PNLTRI.TRAP_LEFT)}};
PNLTRI.Trapezoider=function(a){this.polyData=a;this.queryStructure=new PNLTRI.QueryStructure(this.polyData)};
PNLTRI.Trapezoider.prototype={constructor:PNLTRI.Trapezoider,update_trapezoids:function(){this.queryStructure.update_trapezoids()},math_logstar_n:function(a){var b;for(b=0;1<=a;b++)a=PNLTRI.Math.log2(a);return b-1},math_NH:function(a,b){var c,d;c=0;for(d=a;c<b;c++)d=PNLTRI.Math.log2(d);return Math.ceil(1*a/d)},find_new_roots:function(a){a.is_inserted||(a.rootFrom=this.queryStructure.ptNode(a.vFrom.pt,a.vTo.pt,a.rootFrom),a.rootTo=this.queryStructure.ptNode(a.vTo.pt,a.vFrom.pt,a.rootTo))},trapezoide_polygon:function(){var a=
this.queryStructure.segListArray.slice(0);PNLTRI.Math.array_shuffle(a);var b,c,d=a.length,e=this.math_logstar_n(d);for(c=1;c<=e;c++){for(b=this.math_NH(d,c-1);b<this.math_NH(d,c);b++)this.queryStructure.add_segment(a[b-1]);for(b=0;b<d;b++)this.find_new_roots(a[b])}for(b=this.math_NH(d,e);b<=d;b++)this.queryStructure.add_segment(a[b-1]);return this.queryStructure.find_first_inside()}};PNLTRI.TRAP_NOSPLIT=-1;PNLTRI.MonoSplitter=function(a){this.polyData=a;this.startTrap=this.trapezoider=null};
PNLTRI.MonoSplitter.prototype={constructor:PNLTRI.MonoSplitter,monotonate_trapezoids:function(){this.trapezoider=new PNLTRI.Trapezoider(this.polyData);this.startTrap=this.trapezoider.trapezoide_polygon();this.trapezoider.update_trapezoids();this.polyData.initMonoChains();this.alyTrap(0,this.startTrap,null,null,null);return this.polyData.normalize_monotone_chains()},doSplit:function(a,b,c,d){return d?this.polyData.splitPolygonChain(a,b,c):this.polyData.splitPolygonChain(a,c,b)},alyTrap:function(a,
b,c,d,e){function k(a){for(var b=a.length-1;0<=b;b--)l.unshift(a[b])}var l=[],h=[];null==c&&(d=!0,b.u0?c=!0:b.d0?c=!1:(d=!1,c=b.u1?!0:!1));for(k([[b,c,d,a]]);h=l.shift();){var g;if((g=h[0])&&!g.monoDiag){if(!g.lseg||!g.rseg)return console.log("ERR alyTrap: lseg/rseg missing",g),g.monoDiag=PNLTRI.TRAP_NOSPLIT,l;a=h[1];b=h[2];var h=h[3],p;p=g.hiVert;var q=g.loVert,f=null,r,m;g.topLoc==PNLTRI.TRAP_MIDDLE&&(f=!0,r=g.u0,m=g.u1);g.botLoc==PNLTRI.TRAP_MIDDLE&&(f=!1,r=g.d0,m=g.d1);g.monoDiag=1+4*g.topLoc+
g.botLoc;null!=f?g.topLoc==PNLTRI.TRAP_CUSP||g.botLoc==PNLTRI.TRAP_CUSP?(p=this.doSplit(h,q,p,b),k([[b?r:m,!a,b,h],[b?m:r,!a,!b,p]])):g.topLoc==PNLTRI.TRAP_MIDDLE&&g.botLoc==PNLTRI.TRAP_MIDDLE?(p=this.doSplit(h,q,p,b),b||(a=p,p=h,h=a),k([[g.u0,!1,!0,h],[g.d0,!0,!0,h],[g.u1,!1,!1,p],[g.d1,!0,!1,p]])):(f?(c=g.d0?g.d0:g.d1,d=g.botLoc==PNLTRI.TRAP_LEFT):(c=g.u0?g.u0:g.u1,d=g.topLoc==PNLTRI.TRAP_LEFT),a==f&&b==d?h=this.doSplit(h,q,p,d):(p=this.doSplit(h,q,p,!d),k([[d?r:m,!f,d,p]])),k([[d?m:r,!f,!d,h],
[c,f,!d,h]])):(g.topLoc==PNLTRI.TRAP_CUSP||g.botLoc==PNLTRI.TRAP_CUSP?g.monoDiag=PNLTRI.TRAP_NOSPLIT:(g.topLoc==g.botLoc?g.monoDiag=PNLTRI.TRAP_NOSPLIT:h=g.topLoc==PNLTRI.TRAP_LEFT?this.doSplit(h,q,p,!a):this.doSplit(h,q,p,a),a=!a),a?(c=g.u0?g.u0:g.u1,d=g.topLoc==PNLTRI.TRAP_LEFT):(c=g.d0?g.d0:g.d1,d=g.botLoc==PNLTRI.TRAP_LEFT),k([[c,!a,!d,h]]))}if(e)return l}return[]}};PNLTRI.MonoTriangulator=function(a){this.polyData=a};
PNLTRI.MonoTriangulator.prototype={constructor:PNLTRI.MonoTriangulator,triangulate_all_polygons:function(){var a=this.polyData.getMonoSubPolys();this.polyData.clearTriangles();for(var b=0;b<a.length;b++){var c=a[b],d=c.mprev,e=c.mnext;e.mnext==d?this.polyData.addTriangle(c.vFrom,e.vFrom,d.vFrom):this.triangulate_single_polygon(c)}},triangulate_single_polygon:function(a){var b=a.mnext;a=a.vFrom;for(var c=[b.vFrom],d=0,b=b.mnext,e=b.vFrom;e!=a||1<d;)if(0<d)if(0<PNLTRI.Math.ptsCrossProd(e.pt,c[d-1].pt,
c[d].pt))this.polyData.addTriangle(c[d-1],c[d],e),d--;else if(c[++d]=e,e==a)for(console.log("ERR uni-y-monotone: only concave angles left",c);1<d;)d--,this.polyData.addTriangle(c[d-1],c[d],c[d+1]);else b=b.mnext,e=b.vFrom;else c[++d]=e,b=b.mnext,e=b.vFrom;this.polyData.addTriangle(c[d-1],c[d],e)}};PNLTRI.Triangulator=function(){this.lastPolyData=null};PNLTRI.Triangulator.prototype={constructor:PNLTRI.Triangulator,triangulate_polygon:function(a){if(!a||0==a.length)return[];a=new PNLTRI.PolygonData(a);(new PNLTRI.MonoSplitter(a)).monotonate_trapezoids();(new PNLTRI.MonoTriangulator(a)).triangulate_all_polygons();this.lastPolyData=a;return a.getTriangles()}};
