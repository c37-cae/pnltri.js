// pnltri.js / raw.github.com/jahting/pnltri.js/master/LICENSE
'use strict';var r={ea:"1.4"};r.f={random:Math.random,fa:function(a){for(var b=a.length-1;0<b;b--){var c=Math.floor(r.f.random()*(b+1)),e=a[b];a[b]=a[c];a[c]=e}return a},V:function(a,b,c){return(b.x-a.x)*(c.y-a.y)-(b.y-a.y)*(c.x-a.x)},ca:function(a){return Math.sqrt(a.x*a.x+a.y*a.y)},ha:function(a,b){return a.x*b.x+a.y*b.y},ga:function(a,b){return a.x*b.y-b.x*a.y},ia:function(a,b,c){b={x:b.x-a.x,y:b.y-a.y};a={x:c.x-a.x,y:c.y-a.y};c=r.f.ha(b,a)/r.f.ca(b)/r.f.ca(a);return 0<=r.f.ga(b,a)?1-c:3+c},R:function(a,b){var c=a.y-b.y;if(c<
r.f.F)return-1;if(c>r.f.m)return 1;c=a.x-b.x;return c<r.f.F?-1:c>r.f.m?1:0}};r.f.m=Math.pow(2,-43);r.f.F=-r.f.m;function v(a){this.da=[];this.q=[];this.M=0;this.G=[];this.n=[];this.W=[];if(a)for(var b=0,c=a.length;b<c;b++){var e=w(this,a[b]);if(3>e.length)console.log("Polygon has < 3 vertices!",e);else{for(var d=void 0,h=void 0,g=void 0,f=0;f<e.length-1;f++)d=y(this,e[f],e[f+1]),g?(d.o=g,g.l=d):h=d,g=d,this.q.push(d);d=y(this,e[e.length-1],e[0]);d.o=g;g.l=d;this.q.push(d);h.o=d;d.l=h;this.G[this.M++]=!0}}}v.prototype={S:function(){return this.G.concat()}};function B(a,b,c,e){a.W.push([b.id,c.id,e.id])}
function D(a,b,c,e,d){var h=E(c,e).O,g=E(e,c).O,f=F(a,{c:c,j:e,B:!0,h:h.h,g:g});c=F(a,{c:e,j:c,B:!1,h:g.h,g:h});h.h.g=f;g.h.g=c;h.h=c;g.h=f;h=a.n.length;d?(a.n[b]=f,a.n[h]=c):(a.n[b]=c,a.n[h]=f);return h}function E(a,b){for(var c,e,d=null,h=4,g=0;g<a.v.length;g++)c=a.v[g],(e=r.f.ia(a,c.X,b))<h&&(h=e,d=c);return d}function F(a,b){a.q.push(b);b.c.v.push({O:b,X:b.j});return b}
function w(a,b){function c(a,b){return Math.abs(a.x-b.x)<r.f.m&&Math.abs(a.y-b.y)<r.f.m}for(var e=[],d,h,g,f=0;f<b.length;f++)d=G(a,b[f].x,b[f].y),h=!0,g=e.length-1,0<=g&&c(d,e[g])&&(h=!1),h&&e.push(d);1<e.length&&c(e[e.length-1],e[0])&&e.pop();return e}function y(a,b,c){return{Q:a.M,c:b,j:c,B:1==r.f.R(c,b),o:null,l:null,H:null,I:null,u:!1,J:null,K:null,h:null,g:null,T:!1}}function G(a,b,c){b={id:a.da.length,x:b,y:c,v:[]};a.da.push(b);return b};function H(a){this.i=a}H.prototype={};function I(a,b,c,e){this.D=a?a:{x:Number.POSITIVE_INFINITY,y:Number.POSITIVE_INFINITY};this.k=b?b:{x:Number.NEGATIVE_INFINITY,y:Number.NEGATIVE_INFINITY};this.p=c;this.r=e;this.depth=-1;this.U=!1}I.prototype={};function J(a){var b=new I(a.D,a.k,a.p,a.r);b.d=a.d;b.e=a.e;b.a=a.a;b.b=a.b;b.t=a.t;return b}function K(a){this.w=a;a.t=this}K.prototype={};
function L(a){var b=new I(null,null,null,null);this.A=[];M(this,b);this.root=new K(b);if(a)for(a=a.q,b=0;b<a.length;b++)a[b].H=a[b].I=this.root,a[b].u=!1}L.prototype={L:function(){for(var a,b=0,c=this.A.length;b<c;b++)if(a=this.A[b],1==a.depth%2&&!a.U&&(!a.d&&!a.e||!a.a&&!a.b)&&a.p)return a;return null}};
function O(a,b){function c(){var a=k.d||k.e;a.a&&a.b?k==a.a?(n.d=null,a.a=p):(p.e=null,a.b=n):(n.d=null,n.e=a,a.b=n)}function e(a){k.k==t.k?(q?k.a?(a.d=p,p.a=a,n.b=null):(a.e=n,p.a=null,n.b=a):(a.d=p,a.e=n,p.a=n.b=a),p.b=n.a=null):(a.d&&a.e&&(a.d==k?(a.C=a.e,a.ba=!0):(a.C=a.d,a.ba=!1)),a.d=p,a.e=n,p.b=n.a=a,p.a=n.b=null)}function d(){var a;if(k.k==t.k&&q)k.a.d=p,k.b.e=n,p.a=k.a,n.b=k.b,a=p.b=n.a=null;else{k.a.d=p;k.b.e=n;var c=P(b,k.k);if(0<c)a=k.b,k.b.d=p,p.a=k.a,n.b=null;else if(0>c)a=k.a,k.a.e=
n,n.b=k.b,p.a=null;else{a=k.a.r;var d=a.B,c=d?a.c:a.j,c=P(b,c);0<c?(a=k.b,k.b.d=p,p.a=k.a,n.b=null):0>c?(a=k.a,k.a.e=n,n.b=k.b,p.a=null):(a=d?a.l:a.o,c=d?a.j:a.c,c=P(b,c),0<c?(a=k.b,k.b.d=p,p.a=k.a,n.b=null):(a=k.a,k.a.e=n,n.b=k.b,p.a=null))}p.b=n.a=a}return a}var h,g,f,l,m,q;b.B?(l=b.c,h=b.j,m=b.H,g=b.I,q=b.o.u,f=b.l.u):(l=b.j,h=b.c,m=b.I,g=b.H,q=b.l.u,f=b.o.u);g=Q(h,l,g);f||(g=R(a,g,h,!1));f=g.w;if(f.d||f.e){g=Q(l,h,m);q||(g=R(a,g,l,!0));var t=g.w,k=f,p,n,x,u;for(h=a.A.length+2;k;){if(0>--h){console.log("ERR add_segment: infinite loop",
k,b,a);return}if(!k.a&&!k.b){console.log("ERR add_segment: missing successors",k,b,a);return}l=k.t;l.s=b;l.w=null;u&&u.r==k.r?(p=k,n=u,n.k=k.k,l.left=new K(p),l.right=u.t):(x&&x.p==k.p?(n=k,p=x,p.k=k.k,l.left=x.t):(p=k,n=aa(a,k),l.left=new K(p)),l.right=new K(n));k.d&&k.e?k.C?(k.ba?(n.d=k.e,n.e=k.C,n.d.a=n,n.e.b=n):(p.e=k.d,p.d=k.C,p.d.a=p,p.e.b=p),p.C=n.C=null):k.D==f.D?(n.e.b=n,p.e=n.d=null):n==k?(n.d=n.e,n.e=null,n.d.a=n):(p.e=p.d,p.d=null):c();k.a&&k.b?l=d():(l=k.a?k.a:k.b,e(l));p.r&&(p.r.J=n);
n.p&&(n.p.K=p);p.r=n.p=b;b.J=p;b.K=n;k.k!=t.k?(x=p,u=n,k=l):k=null}b.u=!0}else console.log("ERR add_segment: missing trFirst.uX: ",f)}function Q(a,b,c){for(var e;c;)if(c.Y)e=a==c.Y?b:a,e=r.f.R(e,c.Y),c=-1==e?c.left:c.right;else if(c.s)a==c.s.c||a==c.s.j?Math.abs(a.y-b.y)<r.f.m?c=b.x<a.x?c.left:c.right:(e=P(c.s,b),c=0<e?c.left:0>e?c.right:a==c.s.c?c.right:c.left):(e=P(c.s,a),0<e?c=c.left:0>e?c=c.right:(e=P(c.s,b),c=0<e?c.left:c.right));else return c.w||console.log("ptNode: unknown type",c),c}
function P(a,b){var c,e;e=a.c.x-b.x;var d=a.j.x-b.x;if(Math.abs(a.j.y-b.y)<r.f.m)c=d;else if(Math.abs(a.c.y-b.y)<r.f.m)c=e,e=d;else return a.B?r.f.V(a.c,a.j,b):r.f.V(a.j,a.c,b);return Math.abs(c)<r.f.m?Math.abs(e)<r.f.m?0:e:c}function R(a,b,c,e){var d=b.w;if(d.D==c||d.k==c)return b;var h=J(d);d.k=h.D=c;d.a=h;h.d=d;d.b=h.e=null;h.a&&(h.a.d=h);h.b&&(h.b.e=h);M(a,h);b.Y=c;b.w=null;b.right=new K(d);b.left=new K(h);return e?d.t:h.t}function aa(a,b){var c=J(b);M(a,c);return c}
function M(a,b){b.ka=a.A.length;a.A.push(b)}function W(a){this.i=a;this.$=new L(this.i)}W.prototype={L:function(){return this.$.L()}};function X(a){this.i=a;this.aa=this.P=null}X.prototype={};
function ba(a,b,c){var e=null,d=null;function h(){var a;return(a=g.pop())?(f=a[0],l=a[1],m=a[2],q=a[3],!0):!1}var g=[],f,l,m,q,t;null==e&&(d=!0,c.d?e=!0:c.a?e=!1:(d=!1,e=c.e?!0:!1));for(c&&g.push([c,e,d,b]);h();)if(!f.U){f.U=!0;if(!f.p||!f.r){console.log("ERR alyTrap: lseg/rseg missing",f);break}l?m?(b=f.d,c=f.e,e=f.a,d=f.b):(b=f.e,c=f.d,e=f.b,d=f.a):m?(b=f.a,c=f.b,e=f.d,d=f.e):(b=f.b,c=f.a,e=f.e,d=f.d);if(c||d)t=D(a.i,q,f.k,f.D,m);d&&g.push([d,l,!m,t]);c&&g.push([c,!l,!m,t]);e&&g.push([e,l,m,q]);
e||d||b&&g.push([b,!l,m,q])}};function Y(a){this.i=a}Y.prototype={};function Z(){this.N=null}
Z.prototype={Z:function(){this.N=null},S:function(){return this.N?this.N.S():null},ja:function(a,b){this.Z();if(!a||0==a.length)return[];var c=new v(a),e=b?!1:1==c.M;if(e){e=new H(c);a:{var d=e.i,h=d.q[0],g=h,f=h,l=0;do l+=(f.c.x-f.j.x)*(f.c.y+f.j.y),f=f.l;while(f!=h);if(0>l){do g.h=g.l,g=g.g=g.o;while(g!=h);d.G[0]=!1}else{do g.h=g.o,g=g.g=g.l;while(g!=h)}for(h=d=h;d.g!=d.h;){b:{var g=d.h.c.x,f=d.h.c.y,l=d.c.x,m=d.c.y,q=d.g.c.x,t=d.g.c.y,k=q-l,p=t-m,n=g-q,x=f-t,u=l-g,N=m-f;if(r.f.m>u*p-k*N)g=!1;else{for(var $=
d.h.h,C=d.g;C!=$;){var C=C.g,z=C.c.x,A=C.c.y,S=z-g,T=A-f;if(0!=S||0!=T){var U=z-l,V=A-m;if(0!=U||0!=V)if(z-=q,A-=t,(0!=z||0!=A)&&k*V-p*U>=r.f.F&&u*T-N*S>=r.f.F&&n*A-x*z>=r.f.F){g=!1;break b}}}g=!0}}if(g)B(e.i,d.h.c,d.c,d.g.c),d.h.g=d.g,d.g.h=d.h,h=d=d.g;else if(d=d.g,d==h){e=!1;break a}}e=!0}}if(!e){e=new X(c);e.P=new W(e.i);h=e.P;d=h.i.q.concat();r.f.fa(d);g=0;f=h.i.M;if(1!=f)for(l=Array(f),m=d.concat(),q=0;q<m.length;q++)t=m[q].Q,l[t]?d[f++]=m[q]:(d[g++]=m[q],l[t]=!0);g=d.length;f=h.$;l=0;for(m=
g;l<g;){m=Math.log(m)/Math.LN2;for(q=1<m?Math.floor(g/m):g;l<q;l++)O(f,d[l]);for(q=l;q<g;q++)t=d[q],t.H=Q(t.c,t.j,t.H),t.I=Q(t.j,t.c,t.I)}var h=h.i,f=[f.A[0]],l=[],s,q=0;do{for(t=1==q%2;m=f.pop();)-1==m.depth&&(m.depth=q,m.d&&f.push(m.d),m.e&&f.push(m.e),m.a&&f.push(m.a),m.b&&f.push(m.b),(s=m.p)&&-1==s.J.depth&&l.push(s.J),s=m.r)&&(-1==s.K.depth&&l.push(s.K),s.B!=t&&(h.G[s.Q]=!1));f=l;l=[];q++}while(0<f.length);for(q=0;q<g;q++)d[q].J=d[q].K=null;e.aa=e.P.L();s=e.i;for(h=0;h<s.q.length;h++)d=s.q[h],
s.G[d.Q]?(d.h=d.o,d.g=d.l,d.c.v.push({O:d,X:d.j})):(d=d.l,d.h=d.l,d.g=d.o,d.c.v.push({O:d,X:s.q[h].c}));for(s=e.aa;s;)d=ba,h=e,g=e.i,f=g.n.length,g.n[f]=s.p,d(h,f,s),s=e.P.L();s=e.i;l=[];for(m=0;m<s.n.length;m++){e=d=s.n[m];g=f=e.c;e.T=!0;e=e.g;for(q=!1;(h=e.c)!=g;){if(e.T){q=!0;break}else e.T=!0;1==r.f.R(h,f)&&(f=h,d=e);e=e.g}q||l.push(d)}s.n=l;s=e=new Y(c);e=s.i.n;s.i.W=[];for(d=0;d<e.length;d++)if(f=e[d],h=f.h,g=f.g,g.g==h)B(s.i,f.c,g.c,h.c);else if(h=s,g=f.g,f=f.c,l=[g.c],m=0,g=g.g,q=g.c,q!=f){for(;q!=
f||1<m;)if(0<m)if(0<r.f.V(q,l[m-1],l[m]))B(h.i,l[m-1],l[m],q),m--;else if(l[++m]=q,q==f)for(console.log("ERR uni-y-monotone: only concave angles left",l);1<m;)m--,B(h.i,l[m-1],l[m],l[m+1]);else g=g.g,q=g.c;else l[++m]=q,g=g.g,q=g.c;B(h.i,l[m-1],l[m],q)}s=c.q;for(e=0;e<s.length;e++)s[e].c.v=null}this.N=c;return c.W.concat()}};window.PNLTRI=r;r.REVISION=r.ea;r.Math=r.f;r.Triangulator=Z;Z.prototype.clear_lastData=Z.prototype.Z;Z.prototype.get_PolyLeftArr=Z.prototype.S;Z.prototype.triangulate_polygon=Z.prototype.ja;
